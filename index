<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å–®å­—å¤§å†’éšª (Collector's Edition)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #87CEEB;
            --primary-color: #FFCB05;
            --secondary-color: #2a75bb;
            --danger-color: #ff3333;
            --success-color: #4caf50;
            --font-main: 'Comic Sans MS', 'Microsoft JhengHei', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        .game-frame {
            width: 100%;
            max-width: 600px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            border: 5px solid var(--secondary-color);
            box-shadow: 0 10px 0 rgba(0,0,0,0.2);
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: #eee;
            padding: 5px 10px;
            border-radius: 10px;
            border: 2px solid #ccc;
        }
        .currency-box {
            display: flex; align-items: center; gap: 5px; font-weight: bold; color: #333; font-size: 1.1em;
        }
        .ball-icon { width: 24px; height: 24px; }
        
        .menu-btns { display: flex; gap: 5px; }
        .btn-top {
            color: white; border: none; padding: 5px 12px;
            border-radius: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
            font-size: 0.9em;
        }
        .btn-top:active { transform: translateY(3px); box-shadow: none; }
        .btn-shop { background: #9c27b0; }
        .btn-bag { background: #ff5722; }

        /* --- æˆ°é¬¥å ´æ™¯ --- */
        .battle-scene {
            height: 240px;
            background: #e0f7fa;
            border-radius: 15px;
            border: 3px solid #333;
            position: relative;
            margin-bottom: 20px;
            background-image: radial-gradient(circle at 50% 120%, #81c784 40%, transparent 40%); 
        }

        .hp-box {
            position: absolute;
            background: #fff; border: 2px solid #333; border-radius: 8px;
            padding: 5px 10px; width: 130px; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); z-index: 10;
        }
        .hp-label { font-size: 0.8em; font-weight: bold; display: flex; justify-content: space-between;}
        .hp-bar-bg { width: 100%; height: 8px; background: #555; border-radius: 5px; margin-top: 3px; overflow: hidden;}
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.3s ease-out; }
        .hp-green { background: #4caf50; }
        .hp-red { background: #f44336; }
        .hp-yellow { background: #ffeb3b; }

        .enemy-hud { top: 15px; left: 15px; }
        .enemy-pos { 
            position: absolute; top: 40px; right: 30px; 
            width: 140px; height: 140px;
            display: flex; justify-content: center; align-items: center;
        }
        .enemy-img {
            width: 100%; height: 100%;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            transition: filter 0.2s;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }

        .player-hud { bottom: 25px; right: 15px; }
        .player-pos {
            position: absolute; bottom: 10px; left: 30px;
            width: 100px; height: 100px;
        }
        .player-img {
            width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/25.png'); 
            background-size: contain; background-repeat: no-repeat; background-position: bottom;
            transform: scale(1.5);
        }

        /* --- ç‰¹æ•ˆ --- */
        .damage-text {
            position: absolute; font-size: 2em; font-weight: 900; color: #ff3333;
            text-shadow: 2px 2px 0 #fff; pointer-events: none;
            animation: floatUp 0.8s ease-out forwards; z-index: 20;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.5); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        .shake { animation: shakeAnim 0.5s; }
        @keyframes shakeAnim {
            0% { transform: translate(0, 0); }
            20% { transform: translate(-10px, 0); filter: hue-rotate(90deg); }
            40% { transform: translate(10px, 0); }
            60% { transform: translate(-10px, 0); }
            80% { transform: translate(10px, 0); }
            100% { transform: translate(0, 0); filter: none; }
        }

        .attack-anim { animation: lunge 0.2s forwards; }
        @keyframes lunge {
            0% { transform: translateX(0); }
            50% { transform: translateX(50px) scale(1.1); }
            100% { transform: translateX(0); }
        }

        /* --- æ§åˆ¶å€ --- */
        .control-panel { text-align: center; }
        
        .question-box {
            background: #fff; padding: 10px; border-radius: 10px; border: 2px dashed #aaa;
            margin-bottom: 15px; min-height: 60px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .q-word { font-size: 1.8em; color: var(--secondary-color); font-weight: bold; }
        .q-hint { color: #666; font-size: 0.9em; margin-top: 5px;}

        .input-area { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        #userInput {
            padding: 10px; font-size: 1.2em; border: 3px solid #ccc; border-radius: 10px;
            width: 140px; text-align: center; font-weight: bold; font-family: monospace;
        }
        #userInput:focus { border-color: var(--primary-color); outline: none; }

        .btn {
            border: none; border-radius: 10px; padding: 10px 15px;
            font-size: 1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; color: white;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:disabled { background: #ccc !important; box-shadow: none !important; cursor: not-allowed; }

        .btn-atk { background: var(--success-color); flex-grow: 1; max-width: 100px; }
        .btn-run { background: #ff9800; }
        .btn-voice { background: #2196f3; font-size: 0.9em; padding: 8px 12px; min-width: 80px;}

        .voice-controls {
            display: flex; justify-content: center; gap: 10px; align-items: center; margin-bottom: 5px;
        }

        .level-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(35px, 1fr));
            gap: 5px; margin-bottom: 15px;
        }
        .lvl-btn {
            background: #fff; border: 2px solid var(--secondary-color); color: var(--secondary-color);
            border-radius: 5px; padding: 5px; font-weight: bold; cursor: pointer;
        }
        .lvl-btn.active { background: var(--primary-color); color: #333; border-color: #333; }

        .msg-box { height: 25px; font-weight: bold; color: #333; margin-top: 5px; }
        
        /* --- å½ˆçª—é€šç”¨ --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 15px; width: 85%; max-height: 80%;
            text-align: center; border: 4px solid var(--secondary-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        /* å•†åº—ç‰¹å®š */
        .shop-content { border-color: #9c27b0; }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #f3e5f5; padding: 10px; border-radius: 10px; margin: 15px 0;
            border: 2px solid #e1bee7;
        }
        .shop-price { color: #d32f2f; font-weight: bold; }
        .btn-buy { background: #9c27b0; padding: 5px 15px; font-size: 0.9em;}

        /* èƒŒåŒ…ç‰¹å®š */
        .bag-content { border-color: #ff5722; }
        .pokedex-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-top: 10px; padding: 5px;
        }
        .poke-card {
            background: #fbe9e7; border: 1px solid #ffccbc; border-radius: 8px;
            padding: 5px; display: flex; flex-direction: column; align-items: center;
        }
        .poke-card img { width: 60px; height: 60px; object-fit: contain; }
        .poke-name { font-size: 0.8em; font-weight: bold; color: #333; margin-top: 2px; }
        
        .btn-photo { background: #00bcd4; width: 100%; margin-top: 10px; }
        .btn-close { background: #666; margin-top: 10px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="game-frame">
    <div class="top-bar">
        <div class="currency-box">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="ball-icon" alt="Ball">
            x <span id="ballCount">0</span>
        </div>
        <div class="menu-btns">
            <button class="btn-top btn-bag" id="btnBag">ğŸ’ èƒŒåŒ…</button>
            <button class="btn-top btn-shop" id="btnShop">ğŸ›’ å•†åº—</button>
        </div>
    </div>

    <div class="level-grid" id="levelGrid"></div>

    <div class="battle-scene">
        <div class="hp-box enemy-hud">
            <div class="hp-label"><span>é‡ç”Ÿå¯¶å¯å¤¢</span> <span id="enemyHpText">100%</span></div>
            <div class="hp-bar-bg"><div class="hp-bar-fill hp-red" id="enemyHpBar"></div></div>
        </div>
        <div class="enemy-pos">
            <div class="enemy-img" id="enemyImg"></div>
        </div>

        <div class="hp-box player-hud">
            <div class="hp-label"><span>è¨“ç·´å®¶</span> <span id="playerHpText">100%</span></div>
            <div class="hp-bar-bg"><div class="hp-bar-fill hp-green" id="playerHpBar"></div></div>
        </div>
        <div class="player-pos">
            <div class="player-img" id="playerImg"></div>
        </div>
    </div>

    <div class="control-panel">
        <div class="question-box">
            <div id="qText" class="q-word">è«‹å…ˆé¸æ“‡ä¸Šæ–¹é—œå¡</div>
            <div id="qHint" class="q-hint"></div>
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="è¼¸å…¥å–®å­—..." disabled autocomplete="off">
            <button class="btn btn-atk" id="btnAction" disabled>æ”»æ“Š</button>
            <button class="btn btn-run" id="btnRun" disabled>é€ƒè·‘</button>
        </div>

        <div class="voice-controls">
            <button class="btn btn-voice" id="btnVoiceWord" disabled>ğŸ”Š å–®å­—</button>
            <button class="btn btn-voice" id="btnVoiceSent" disabled>ğŸ”Š ä¾‹å¥</button>
            <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="1.0" title="èªé€Ÿ" style="width: 70px;">
        </div>
        
        <div class="msg-box" id="msgBox">æº–å‚™æˆ°é¬¥ï¼</div>
    </div>

    <div class="modal-overlay" id="shopModal">
        <div class="modal-content shop-content">
            <h2 style="margin:0 0 10px 0; color:#9c27b0;">å¯¶å¯å¤¢ä¸­å¿ƒå•†åº—</h2>
            <p>ç”¨ç²¾éˆçƒäº¤æ›é“å…·ï¼Œå¹«åŠ©ä½ æˆ°é¬¥ï¼</p>
            <div class="shop-item">
                <div style="text-align:left;">
                    <div style="font-weight:bold;">ğŸ’– å…¨æ»¿è—¥ (Potion)</div>
                    <div style="font-size:0.8em; color:#666;">å›å¾© 1 é»ç”Ÿå‘½å€¼</div>
                </div>
                <div style="text-align:right;">
                    <div class="shop-price">3 çƒ</div>
                    <button class="btn btn-buy" id="btnBuyPotion">è³¼è²·</button>
                </div>
            </div>
            <button class="btn btn-close" id="btnCloseShop">é›¢é–‹</button>
        </div>
    </div>

    <div class="modal-overlay" id="bagModal">
        <div class="modal-content bag-content" id="bagContentArea">
            <h2 style="margin:0 0 10px 0; color:#ff5722;">æˆ‘çš„èƒŒåŒ… (å·²æ”¶æœ)</h2>
            <div id="pokedexGrid" class="pokedex-grid">
                </div>
            <p id="emptyBagMsg" style="color:#888;">ç›®å‰é‚„æ˜¯ç©ºçš„ï¼Œå¿«å»æˆ°é¬¥å§ï¼</p>
            
            <button class="btn btn-photo" id="btnPhoto">ğŸ“¸ åˆå½±ç•™å¿µ (ä¸‹è¼‰åœ–ç‰‡)</button>
            <button class="btn btn-close" id="btnCloseBag">é—œé–‰</button>
        </div>
    </div>
</div>

<script>
    const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/karltpe/MikeEnglishTest/main/word_ad.json';
    
    // éš¨æ©Ÿå¯¶å¯å¤¢åœ– (1-1010)
    function getRandomPokemonImage() {
        const id = Math.floor(Math.random() * 1010) + 1;
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
    }

    // éŠæˆ²ç‹€æ…‹
    let wordList = [];
    let battleQueue = [];
    let currentEnemy = null;
    let currentEnemyImgUrl = ''; // ç´€éŒ„ç•¶å‰æ€ªç‰©çš„åœ–ç‰‡ç¶²å€
    let selectedLetters = new Set();
    
    let playerMaxHp = 3; 
    let playerHp = 3;
    let enemyHp = 100;
    let pokeBalls = 0; 
    
    // èƒŒåŒ…è³‡æ–™ (å„²å­˜å·²æŠ“åˆ°çš„ {word: 'apple', img: 'url...'} )
    let caughtPokemon = []; 
    
    let isFighting = false;
    let isRevealed = false;

    // DOM
    const el = {
        levelGrid: document.getElementById('levelGrid'),
        enemyHpBar: document.getElementById('enemyHpBar'),
        enemyHpText: document.getElementById('enemyHpText'),
        playerHpBar: document.getElementById('playerHpBar'),
        playerHpText: document.getElementById('playerHpText'),
        enemyImg: document.getElementById('enemyImg'),
        playerImg: document.getElementById('playerImg'),
        qText: document.getElementById('qText'),
        qHint: document.getElementById('qHint'),
        input: document.getElementById('userInput'),
        btnAction: document.getElementById('btnAction'),
        btnRun: document.getElementById('btnRun'),
        btnVoiceWord: document.getElementById('btnVoiceWord'),
        btnVoiceSent: document.getElementById('btnVoiceSent'),
        msgBox: document.getElementById('msgBox'),
        scene: document.querySelector('.battle-scene'),
        rateSlider: document.getElementById('rateSlider'),
        ballCount: document.getElementById('ballCount'),
        
        // Modal
        btnShop: document.getElementById('btnShop'),
        shopModal: document.getElementById('shopModal'),
        btnBuyPotion: document.getElementById('btnBuyPotion'),
        btnCloseShop: document.getElementById('btnCloseShop'),
        
        btnBag: document.getElementById('btnBag'),
        bagModal: document.getElementById('bagModal'),
        pokedexGrid: document.getElementById('pokedexGrid'),
        emptyBagMsg: document.getElementById('emptyBagMsg'),
        btnPhoto: document.getElementById('btnPhoto'),
        btnCloseBag: document.getElementById('btnCloseBag'),
        bagContentArea: document.getElementById('bagContentArea')
    };

    // --- éŸ³æ•ˆç³»çµ± ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    const SFX = {
        attack: () => { playTone(600, 'sawtooth', 0.1); setTimeout(() => playTone(300, 'square', 0.1), 100); },
        hit: () => { playTone(100, 'sawtooth', 0.3); },
        error: () => { playTone(150, 'sawtooth', 0.2); setTimeout(() => playTone(100, 'sawtooth', 0.2), 150); },
        win: () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(500, 'sine', 0.1), 150); setTimeout(() => playTone(600, 'sine', 0.2), 300); },
        coin: () => { playTone(1000, 'sine', 0.1); setTimeout(() => playTone(1500, 'sine', 0.2), 100); }, 
        heal: () => { playTone(400, 'sine', 0.2); setTimeout(() => playTone(600, 'sine', 0.3), 200); },
        camera: () => { playTone(800, 'square', 0.1); }
    };

    // --- åˆå§‹åŒ– ---
    window.onload = async () => {
        const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        abc.forEach(char => {
            const b = document.createElement('div');
            b.className = 'lvl-btn';
            b.textContent = char;
            b.onclick = () => toggleLevel(char, b);
            el.levelGrid.appendChild(b);
        });

        try {
            el.msgBox.textContent = "æ­£åœ¨ä¸‹è¼‰å–®å­—åœ–é‘‘...";
            const res = await fetch(GITHUB_JSON_URL + '?t=' + Date.now());
            if(!res.ok) throw new Error("é€£ç·šå¤±æ•—");
            wordList = await res.json();
            el.msgBox.textContent = `âœ… æº–å‚™å®Œæˆï¼å…± ${wordList.length} å€‹å–®å­—ã€‚è«‹é¸é—œå¡ã€‚`;
            el.msgBox.style.color = "green";
        } catch(e) {
            el.msgBox.textContent = "âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
            el.msgBox.style.color = "red";
        }
    };

    // --- å½ˆçª—ç³»çµ± (å•†åº— & èƒŒåŒ…) ---
    el.btnShop.onclick = () => { el.shopModal.style.display = 'flex'; updateShopUI(); };
    el.btnCloseShop.onclick = () => { el.shopModal.style.display = 'none'; };
    
    el.btnBag.onclick = () => { 
        el.bagModal.style.display = 'flex'; 
        renderBag();
    };
    el.btnCloseBag.onclick = () => { el.bagModal.style.display = 'none'; };

    // è³¼è²·è£œè¡€
    el.btnBuyPotion.onclick = () => {
        if (pokeBalls >= 3 && playerHp < playerMaxHp) {
            pokeBalls -= 3;
            playerHp++;
            SFX.heal();
            updateStats();
            updateShopUI();
            el.msgBox.textContent = "ğŸ’– é«”åŠ›æ¢å¾©ï¼";
            el.msgBox.style.color = "#e91e63";
        } else if (playerHp >= playerMaxHp) {
            alert("é«”åŠ›å·²ç¶“æ»¿äº†ï¼");
        } else {
            alert("ç²¾éˆçƒä¸å¤ å–”ï¼");
        }
    };

    function updateShopUI() {
        el.btnBuyPotion.textContent = (playerHp >= playerMaxHp) ? "é«”åŠ›å·²æ»¿" : "è³¼è²· (3çƒ)";
        el.btnBuyPotion.disabled = (playerHp >= playerMaxHp || pokeBalls < 3);
    }

    // æ¸²æŸ“èƒŒåŒ…
    function renderBag() {
        el.pokedexGrid.innerHTML = '';
        if (caughtPokemon.length === 0) {
            el.emptyBagMsg.style.display = 'block';
            el.btnPhoto.style.display = 'none';
        } else {
            el.emptyBagMsg.style.display = 'none';
            el.btnPhoto.style.display = 'block';
            
            caughtPokemon.forEach(p => {
                const card = document.createElement('div');
                card.className = 'poke-card';
                card.innerHTML = `
                    <img src="${p.img}" alt="Pokemon">
                    <div class="poke-name">${p.word}</div>
                `;
                el.pokedexGrid.appendChild(card);
            });
        }
    }

    // æ‹ç…§åŠŸèƒ½
    el.btnPhoto.onclick = () => {
        SFX.camera();
        el.btnPhoto.textContent = "ğŸ“· ç”¢ç”Ÿä¸­...";
        // éš±è—ä¸éœ€è¦çš„æŒ‰éˆ•ä»¥ç¾åŒ–æˆªåœ–
        el.btnPhoto.style.visibility = 'hidden';
        el.btnCloseBag.style.visibility = 'hidden';

        html2canvas(el.bagContentArea, { 
            useCORS: true, 
            scale: 2,
            backgroundColor: "#ffffff"
        }).then(canvas => {
            // é‚„åŸæŒ‰éˆ•
            el.btnPhoto.style.visibility = 'visible';
            el.btnCloseBag.style.visibility = 'visible';
            el.btnPhoto.textContent = "ğŸ“¸ åˆå½±ç•™å¿µ (ä¸‹è¼‰åœ–ç‰‡)";

            // ä¸‹è¼‰
            const link = document.createElement('a');
            link.download = 'my-pokemon-collection.png';
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => {
            console.error(err);
            alert("æˆªåœ–å¤±æ•— (å¯èƒ½æ˜¯åœ–ç‰‡è·¨åŸŸå•é¡Œ)ï¼Œè«‹å˜—è©¦ä½¿ç”¨ç€è¦½å™¨å…§å»ºæˆªåœ–ã€‚");
            el.btnPhoto.style.visibility = 'visible';
            el.btnCloseBag.style.visibility = 'visible';
            el.btnPhoto.textContent = "ğŸ“¸ åˆå½±ç•™å¿µ (ä¸‹è¼‰åœ–ç‰‡)";
        });
    };

    // --- éŠæˆ²é‚è¼¯ ---
    function toggleLevel(char, btn) {
        if(isFighting || isRevealed) {
            if(!confirm("æˆ°é¬¥ä¸­åˆ‡æ›æœƒé‡ç½®é€²åº¦ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            resetGame();
        }
        if(selectedLetters.has(char)) {
            selectedLetters.delete(char);
            btn.classList.remove('active');
        } else {
            selectedLetters.add(char);
            btn.classList.add('active');
        }
        if(selectedLetters.size > 0) {
            el.btnAction.textContent = "é–‹å§‹æˆ°é¬¥";
            el.btnAction.disabled = false;
            el.btnAction.style.background = "#28a745";
            el.msgBox.textContent = `å·²é¸æ“‡ ${Array.from(selectedLetters).join(',')}ï¼ŒæŒ‰é–‹å§‹ï¼`;
        } else {
            el.btnAction.textContent = "è«‹é¸é—œå¡";
            el.btnAction.disabled = true;
            el.btnAction.style.background = "#ccc";
        }
    }

    el.btnAction.onclick = () => {
        if(!isFighting && !isRevealed) initBattle();
        else if(isFighting) playerAttack();
        else if(isRevealed) nextEnemy();
    };

    el.btnRun.onclick = () => {
        if(!isFighting) return;
        SFX.error();
        el.msgBox.textContent = "ğŸ’¨ é€ƒè·‘æˆåŠŸ (è·³é)";
        el.msgBox.style.color = "orange";
        showDamage(0, true);
        revealAnswer(false);
    };

    el.input.addEventListener('keyup', (e) => {
        if(e.key === 'Enter' && !el.btnAction.disabled) el.btnAction.click();
    });

    function initBattle() {
        const pool = wordList.filter(w => selectedLetters.has(w.word.charAt(0).toUpperCase()));
        if(pool.length === 0) {
            el.msgBox.textContent = "æ­¤é—œå¡æ²’æœ‰æ€ªç¸ï¼";
            return;
        }
        battleQueue = shuffle(pool);
        playerHp = playerMaxHp;
        updateStats();
        
        el.btnAction.style.background = "#ff3333";
        nextEnemy();
    }

    function nextEnemy() {
        if(playerHp <= 0) { gameOver(false); return; }
        if(battleQueue.length === 0) { gameOver(true); return; }

        currentEnemy = battleQueue.shift();
        isFighting = true;
        isRevealed = false;
        enemyHp = 100;
        updateStats();

        // ç”¢ç”Ÿä¸¦å„²å­˜åœ–ç‰‡é€£çµï¼Œä»¥ä¾¿ä¹‹å¾ŒæŠ“å–
        currentEnemyImgUrl = getRandomPokemonImage();
        el.enemyImg.style.backgroundImage = `url('${currentEnemyImgUrl}')`;

        el.input.value = "";
        el.input.disabled = false;
        el.input.focus();
        el.btnAction.textContent = "æ”»æ“Š (Enter)";
        el.btnAction.disabled = false;
        el.btnRun.disabled = false;
        
        el.btnVoiceWord.disabled = true;
        el.btnVoiceSent.disabled = true;
        
        const type = currentEnemy.type ? `(${currentEnemy.type})` : "";
        el.qText.textContent = `${currentEnemy.cn_word} ${type}`;
        
        let maskedSent = "";
        if(currentEnemy.sentence) {
            const reg = new RegExp(currentEnemy.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            maskedSent = currentEnemy.sentence.replace(reg, '____');
        }
        el.qHint.textContent = maskedSent;
        el.msgBox.textContent = "é‡ç”Ÿå¯¶å¯å¤¢å‡ºç¾äº†ï¼";
        el.msgBox.style.color = "#333";
        
        el.enemyImg.style.filter = "none";
        el.playerImg.classList.remove('shake');
    }

    function playerAttack() {
        const ans = el.input.value.trim().toLowerCase();
        const correct = currentEnemy.word.trim().toLowerCase();

        if(ans === correct) {
            SFX.attack();
            el.playerImg.classList.add('attack-anim');
            setTimeout(() => el.playerImg.classList.remove('attack-anim'), 300);
            
            setTimeout(() => {
                SFX.hit();
                showDamage(100, false);
                enemyHp = 0;
                
                // çå‹µçµç®— & æ”¶å…¥èƒŒåŒ…
                pokeBalls++;
                caughtPokemon.push({ word: currentEnemy.word, img: currentEnemyImgUrl });
                SFX.coin();
                
                updateStats();
                el.enemyImg.style.filter = "brightness(0.2) sepia(1) hue-rotate(-50deg) saturate(5)";
                revealAnswer(true);
            }, 200);

            el.msgBox.textContent = "ğŸ’¥ æˆåŠŸæ”¶æœï¼æ”¾å…¥èƒŒåŒ…ï¼";
            el.msgBox.style.color = "green";
            speak(currentEnemy.word);

        } else {
            SFX.error();
            playerHp--;
            updateStats();
            
            el.playerImg.classList.add('shake');
            setTimeout(() => el.playerImg.classList.remove('shake'), 500);
            showDamage(1, true);

            if(playerHp <= 0) {
                el.msgBox.textContent = "ğŸ˜µ ä½ è¢«æ‰“æ•—äº†...";
                revealAnswer(false);
            } else {
                el.msgBox.textContent = "âŒ æ”»æ“Šå¤±èª¤ï¼å—åˆ°åæ“Šï¼";
                el.msgBox.style.color = "red";
                el.input.value = "";
                el.input.focus();
            }
        }
    }

    function revealAnswer(isWin) {
        isFighting = false;
        isRevealed = true;
        
        el.input.disabled = true;
        el.btnRun.disabled = true;
        el.btnVoiceWord.disabled = false;
        el.btnVoiceSent.disabled = false;
        el.btnAction.textContent = "ä¸‹ä¸€éš»æ€ªç¸";
        el.btnAction.style.background = "#2196f3";

        el.qText.innerHTML = `<span style="color:red; font-size:1.2em;">${currentEnemy.word}</span> <span style="font-size:0.6em; color:#666;">${currentEnemy.KK||''}</span>`;
        if(currentEnemy.sentence) el.qHint.textContent = currentEnemy.sentence;
    }

    function showDamage(amount, isPlayerHurt) {
        const dmg = document.createElement('div');
        dmg.className = 'damage-text';
        dmg.textContent = isPlayerHurt ? `-${amount}` : `-${amount}`;
        dmg.style.color = isPlayerHurt ? 'red' : 'orange';
        if(isPlayerHurt) { dmg.style.left = "60px"; dmg.style.bottom = "100px"; } 
        else { dmg.style.right = "60px"; dmg.style.top = "50px"; }
        el.scene.appendChild(dmg);
        setTimeout(() => dmg.remove(), 800);
    }

    function updateStats() {
        el.enemyHpBar.style.width = enemyHp + "%";
        const pct = (playerHp / playerMaxHp) * 100;
        el.playerHpBar.style.width = pct + "%";
        el.playerHpText.textContent = `${playerHp}/${playerMaxHp}`;
        el.playerHpBar.className = "hp-bar-fill " + (pct > 50 ? "hp-green" : pct > 20 ? "hp-yellow" : "hp-red");
        el.ballCount.textContent = pokeBalls;
    }

    function gameOver(isClear) {
        isFighting = false;
        isRevealed = false;
        el.btnAction.textContent = "é‡æ–°æŒ‘æˆ°";
        el.btnAction.style.background = "#28a745";
        el.btnAction.disabled = false;
        el.input.disabled = true;
        if(isClear) {
            SFX.win();
            el.qText.textContent = "ğŸ† æ­å–œé€šé—œï¼";
            el.qHint.textContent = "æ‰€æœ‰çš„å–®å­—æ€ªç¸éƒ½è¢«ä½ æ”¶æœäº†ï¼";
            el.msgBox.textContent = "å¤ªå¼·äº†ï¼";
        } else {
            SFX.error();
            el.qText.textContent = "ğŸ’€ çœ¼å‰ä¸€ç‰‡æ¼†é»‘...";
            el.qHint.textContent = "è¨“ç·´å®¶å€’ä¸‹äº†ï¼Œè«‹é‡æ–°æŒ‘æˆ°ï¼";
            el.msgBox.textContent = "å‹æ•—ä¹ƒå…µå®¶å¸¸äº‹";
        }
    }

    function resetGame() {
        isFighting = false; isRevealed = false;
        selectedLetters.clear();
        document.querySelectorAll('.lvl-btn.active').forEach(b => b.classList.remove('active'));
        el.btnAction.textContent = "è«‹é¸é—œå¡";
        el.btnAction.disabled = true;
        el.btnAction.style.background = "#ccc";
        el.qText.textContent = "æº–å‚™æˆ°é¬¥";
        el.qHint.textContent = "";
        enemyHp = 100; playerHp = 3;
        updateStats();
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = parseFloat(el.rateSlider.value);
            window.speechSynthesis.speak(u);
        }
    }
    
    el.btnVoiceWord.onclick = () => { if(currentEnemy) speak(currentEnemy.word); };
    el.btnVoiceSent.onclick = () => { if(currentEnemy && currentEnemy.sentence) speak(currentEnemy.sentence); };

</script>
</body>
</html>
