<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å–®å­—å¤§å†’éšª (éœ€ç™»å…¥)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #87CEEB;
            --primary-color: #FFCB05;
            --secondary-color: #2a75bb;
            --danger-color: #ff3333;
            --success-color: #4caf50;
            --boss-color: #673ab7;
            --font-main: 'Comic Sans MS', 'Microsoft JhengHei', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
            margin: 0;
            padding: 0; /* æ»¿ç‰ˆ */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        /* --- ç™»å…¥é®ç½© (Login Overlay) --- */
        #loginOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); /* æ·±è‰²èƒŒæ™¯ */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            backdrop-filter: blur(5px);
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 203, 5, 0.6);
            border: 5px solid var(--primary-color);
            max-width: 90%;
        }
        .login-title {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .btn-google-login {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s, background-color 0.2s;
            margin: 0 auto;
        }
        .btn-google-login:hover {
            background-color: #357ae8;
            transform: scale(1.05);
        }
        .btn-google-login img {
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        /* --- éŠæˆ²ä¸»é«” (é è¨­éš±è—) --- */
        #gameWrapper {
            display: none; /* ç™»å…¥å¾Œæ‰é¡¯ç¤º */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .game-frame {
            width: 100%;
            max-width: 600px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            border: 5px solid var(--secondary-color);
            box-shadow: 0 10px 0 rgba(0,0,0,0.2);
            padding: 15px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.5s;
        }
        
        .game-frame.boss-mode {
            border-color: var(--boss-color);
            box-shadow: 0 0 20px var(--boss-color);
        }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; background: #eee; padding: 5px 10px;
            border-radius: 10px; border: 2px solid #ccc;
        }
        .user-profile {
            display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: #555;
        }
        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;
        }
        .btn-logout {
            background: #ff5252; color: white; border: none; padding: 4px 10px;
            border-radius: 15px; cursor: pointer; font-size: 0.8em;
        }

        .currency-box { display: flex; align-items: center; gap: 5px; font-weight: bold; color: #333; font-size: 1.1em; }
        .stage-box { font-weight: bold; color: var(--secondary-color); }
        .ball-icon { width: 24px; height: 24px; }
        .menu-btns { display: flex; gap: 5px; }
        .btn-top {
            color: white; border: none; padding: 5px 12px; border-radius: 20px;
            font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s; font-size: 0.9em;
        }
        .btn-top:active { transform: translateY(3px); box-shadow: none; }
        .btn-shop { background: #9c27b0; }
        .btn-bag { background: #ff5722; }

        /* --- æˆ°é¬¥å ´æ™¯ --- */
        .battle-scene {
            height: 260px; background: #e0f7fa; border-radius: 15px; border: 3px solid #333;
            position: relative; margin-bottom: 20px;
            background-image: radial-gradient(circle at 50% 120%, #81c784 40%, transparent 40%); 
            transition: filter 0.5s;
        }
        .battle-scene.boss-bg { filter: hue-rotate(240deg); }

        .hp-box {
            position: absolute; background: #fff; border: 2px solid #333; border-radius: 8px;
            padding: 5px 10px; width: 130px; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); z-index: 10;
        }
        .hp-label { font-size: 0.8em; font-weight: bold; display: flex; justify-content: space-between;}
        .hp-bar-bg { width: 100%; height: 8px; background: #555; border-radius: 5px; margin-top: 3px; overflow: hidden;}
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.3s ease-out; }
        .hp-green { background: #4caf50; }
        .hp-red { background: #f44336; }
        .hp-purple { background: #9c27b0; } 

        .enemy-hud { bottom: 20px; right: 20px; }
        .player-hud { top: 20px; left: 20px; }

        .enemy-pos { position: absolute; top: 40px; right: 30px; width: 140px; height: 140px; display: flex; justify-content: center; align-items: center; }
        .enemy-img { width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; transition: all 0.5s; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); }
        .enemy-img.boss-size { transform: scale(1.5); filter: drop-shadow(0 0 15px var(--boss-color)); }

        .player-pos { position: absolute; bottom: 10px; left: 40px; width: 150px; height: 150px; }
        .player-img { width: 100%; height: 100%; background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/25.png'); background-size: contain; background-repeat: no-repeat; background-position: bottom; transform: scale(1.8); transform-origin: bottom center; }

        /* ç‰¹æ•ˆ */
        .damage-text { position: absolute; font-size: 2.5em; font-weight: 900; color: #ff3333; text-shadow: 2px 2px 0 #fff; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 20; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-40px) scale(1.5); opacity: 1; } 100% { transform: translateY(-80px) scale(1); opacity: 0; } }
        .shake { animation: shakeAnim 0.5s; }
        @keyframes shakeAnim { 0% { transform: translate(0, 0); } 20% { transform: translate(-10px, 0); filter: hue-rotate(90deg); } 40% { transform: translate(10px, 0); } 60% { transform: translate(-10px, 0); } 80% { transform: translate(10px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        .attack-anim { animation: lunge 0.2s forwards; }
        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(50px) scale(1.1); } 100% { transform: translateX(0); } }

        /* æ§åˆ¶å€ */
        .control-panel { text-align: center; }
        .question-box { background: #fff; padding: 10px; border-radius: 10px; border: 2px dashed #aaa; margin-bottom: 15px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .q-word { font-size: 1.8em; color: var(--secondary-color); font-weight: bold; }
        .q-hint { color: #666; font-size: 0.9em; margin-top: 5px;}
        .game-over-title { color: #2a75bb; font-size: 2em; font-weight: bold; margin: 10px 0; }
        .game-over-desc { color: #666; font-size: 1.1em; }

        .input-area { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        #userInput { padding: 10px; font-size: 1.2em; border: 3px solid #ccc; border-radius: 10px; width: 200px; text-align: center; font-weight: bold; font-family: monospace; color: #333; }
        #userInput::placeholder { color: #aaa; letter-spacing: 2px; font-weight: normal; }
        #userInput:focus { border-color: var(--primary-color); outline: none; }

        .btn { border: none; border-radius: 10px; padding: 10px 15px; font-size: 1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; color: white; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:disabled { background: #ccc !important; box-shadow: none !important; cursor: not-allowed; }
        .btn-atk { background: var(--success-color); flex-grow: 1; max-width: 100px; }
        .btn-run { background: #ff9800; }
        .btn-voice { background: #2196f3; font-size: 0.9em; padding: 8px 12px; min-width: 80px;}
        .voice-controls { display: flex; justify-content: center; gap: 10px; align-items: center; margin-bottom: 5px; }

        .level-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(35px, 1fr)); gap: 5px; margin-bottom: 15px; }
        .lvl-btn { background: #fff; border: 2px solid var(--secondary-color); color: var(--secondary-color); border-radius: 5px; padding: 5px; font-weight: bold; cursor: pointer; }
        .lvl-btn.active { background: var(--primary-color); color: #333; border-color: #333; }
        .msg-box { height: 25px; font-weight: bold; color: #333; margin-top: 5px; }
        
        /* å½ˆçª— */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 15px; width: 85%; max-height: 80%; text-align: center; border: 4px solid var(--secondary-color); box-shadow: 0 0 20px rgba(0,0,0,0.5); overflow-y: auto; }
        .shop-content { border-color: #9c27b0; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; background: #f3e5f5; padding: 10px; border-radius: 10px; margin: 15px 0; border: 2px solid #e1bee7; }
        .shop-price { color: #d32f2f; font-weight: bold; }
        .btn-buy { background: #9c27b0; padding: 5px 15px; font-size: 0.9em;}
        .bag-content { border-color: #ff5722; }
        .pokedex-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; padding: 5px; }
        .poke-card { background: #fbe9e7; border: 1px solid #ffccbc; border-radius: 8px; padding: 5px; display: flex; flex-direction: column; align-items: center; }
        .poke-card img { width: 60px; height: 60px; object-fit: contain; }
        .poke-name { font-size: 0.8em; font-weight: bold; color: #333; margin-top: 2px; }
        .btn-photo { background: #00bcd4; width: 100%; margin-top: 10px; }
        .btn-close { background: #666; margin-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div class="login-title">ğŸŒŸ å¯¶å¯å¤¢å–®å­—å¤§å†’éšª ğŸŒŸ</div>
        <button id="btnGoogleLogin" class="btn-google-login">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24" height="24">
            ä½¿ç”¨ Google ç™»å…¥é–‹å§‹éŠæˆ²
        </button>
        <p style="margin-top: 20px; color: #666; font-size: 0.9em;">
            è«‹ä½¿ç”¨ Live Server æˆ– GitHub Pages é–‹å•Ÿ<br>
            ç™»å…¥å¾Œå¯è‡ªå‹•å­˜æª”
        </p>
    </div>
</div>

<div id="gameWrapper" style="display: none;">
    
    <div class="game-frame" id="gameFrame">
        <div class="top-bar">
            <div class="user-profile">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                <span id="userName">è¨“ç·´å®¶</span>
                <button id="btnLogout" class="btn-logout">ç™»å‡º</button>
            </div>

            <div class="currency-box">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="ball-icon" alt="Ball">
                x <span id="ballCount">0</span>
            </div>
            <div class="stage-box" id="stageInfo">é—œå¡ 1</div>
            
            <div class="menu-btns">
                <button class="btn-top btn-bag" id="btnBag">ğŸ’ èƒŒåŒ…</button>
                <button class="btn-top btn-shop" id="btnShop">ğŸ›’ å•†åº—</button>
            </div>
        </div>

        <div class="level-grid" id="levelGrid"></div>

        <div class="battle-scene" id="battleScene">
            <div class="hp-box enemy-hud">
                <div class="hp-label"><span id="enemyName">é‡ç”Ÿå¯¶å¯å¤¢</span> <span id="enemyHpText">100%</span></div>
                <div class="hp-bar-bg"><div class="hp-bar-fill hp-red" id="enemyHpBar"></div></div>
            </div>
            <div class="enemy-pos"><div class="enemy-img" id="enemyImg"></div></div>

            <div class="hp-box player-hud">
                <div class="hp-label"><span>è¨“ç·´å®¶</span> <span id="playerHpText">100%</span></div>
                <div class="hp-bar-bg"><div class="hp-bar-fill hp-green" id="playerHpBar"></div></div>
            </div>
            <div class="player-pos"><div class="player-img" id="playerImg"></div></div>
        </div>

        <div class="control-panel">
            <div class="question-box" id="questionBox">
                <div id="qText" class="q-word">è«‹å…ˆé¸æ“‡ä¸Šæ–¹é—œå¡</div>
                <div id="qHint" class="q-hint"></div>
            </div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="è¼¸å…¥å–®å­—..." disabled autocomplete="off">
                <button class="btn btn-atk" id="btnAction" disabled>æ”»æ“Š</button>
                <button class="btn btn-run" id="btnRun" disabled>é€ƒè·‘</button>
            </div>

            <div class="voice-controls">
                <button class="btn btn-voice" id="btnVoiceWord" disabled>ğŸ”Š å–®å­—</button>
                <button class="btn btn-voice" id="btnVoiceSent" disabled>ğŸ”Š ä¾‹å¥</button>
                <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="1.0" title="èªé€Ÿ" style="width: 70px;">
            </div>
            
            <div class="msg-box" id="msgBox">æº–å‚™æˆ°é¬¥ï¼</div>
        </div>

        <div class="modal-overlay" id="shopModal">
            <div class="modal-content shop-content">
                <h2 style="margin:0 0 10px 0; color:#9c27b0;">å¯¶å¯å¤¢ä¸­å¿ƒå•†åº—</h2>
                <div class="shop-item">
                    <div style="text-align:left;">
                        <div style="font-weight:bold;">ğŸ’– å…¨æ»¿è—¥</div>
                        <div style="font-size:0.8em; color:#666;">å›å¾© 1 é»ç”Ÿå‘½å€¼</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="shop-price">3 çƒ</div>
                        <button class="btn btn-buy" id="btnBuyPotion">è³¼è²·</button>
                    </div>
                </div>
                <button class="btn btn-close" id="btnCloseShop">é›¢é–‹</button>
            </div>
        </div>

        <div class="modal-overlay" id="bagModal">
            <div class="modal-content bag-content" id="bagContentArea">
                <h2 style="margin:0 0 10px 0; color:#ff5722;">æˆ‘çš„èƒŒåŒ…</h2>
                <div id="pokedexGrid" class="pokedex-grid"></div>
                <p id="emptyBagMsg" style="color:#888;">ç›®å‰é‚„æ˜¯ç©ºçš„ã€‚</p>
                <button class="btn btn-photo" id="btnPhoto">ğŸ“¸ åˆå½±ç•™å¿µ</button>
                <button class="btn btn-close" id="btnCloseBag">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ***************************************************************
    // âš ï¸ è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ CONFIG (å¦å‰‡æŒ‰éˆ•ä¸æœƒæœ‰åæ‡‰)
    // ***************************************************************
    const firebaseConfig = {
		apiKey: "AIzaSyDob5OyYtOjTXCK16iu741sn6KX-rNWa-Q",
		authDomain: "gept-pokemon-game.firebaseapp.com",
		projectId: "gept-pokemon-game",
		storageBucket: "gept-pokemon-game.firebasestorage.app",
		messagingSenderId: "345364092934",
		appId: "1:345364092934:web:57a18217cdd874c4ed0b87",
		measurementId: "G-NJ756ZPF8M"
    };

    let auth;
    try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        console.log("Firebase è¼‰å…¥æˆåŠŸ");
    } catch (e) {
        console.warn("Firebase æœªè¨­å®šæˆ–åˆå§‹åŒ–å¤±æ•—ã€‚");
        // ç‚ºäº†è®“æ‚¨æ¸¬è©¦ä»‹é¢ï¼Œå¦‚æœæ²’è¨­å®šï¼Œæˆ‘å€‘å‡è£æœ‰ç™»å…¥æŒ‰éˆ•ä½†æœƒè·³éŒ¯
    }

    const overlay = document.getElementById('loginOverlay');
    const gameWrapper = document.getElementById('gameWrapper');
    const btnGoogleLogin = document.getElementById('btnGoogleLogin');
    const btnLogout = document.getElementById('btnLogout');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');

    if (auth) {
        // ç›£è½ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // å·²ç™»å…¥ -> éš±è—é®ç½©ï¼Œé¡¯ç¤ºéŠæˆ²
                overlay.style.display = 'none';
                gameWrapper.style.display = 'flex';
                userName.textContent = user.displayName;
                userAvatar.src = user.photoURL;
                console.log("å·²ç™»å…¥:", user.displayName);
            } else {
                // æœªç™»å…¥ -> é¡¯ç¤ºé®ç½©ï¼Œéš±è—éŠæˆ²
                overlay.style.display = 'flex';
                gameWrapper.style.display = 'none';
            }
        });

        // é»æ“Šç™»å…¥
        btnGoogleLogin.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch((error) => {
                alert("ç™»å…¥å¤±æ•—: " + error.message);
            });
        });

        // é»æ“Šç™»å‡º
        btnLogout.addEventListener('click', () => {
            signOut(auth).then(() => {
                location.reload();
            });
        });
    } else {
        // æ²’æœ‰ Auth (ä¾‹å¦‚ Config æ²’å¡«)ï¼Œç›´æ¥è®“æŒ‰éˆ•å¤±æ•ˆä¸¦æç¤º
        btnGoogleLogin.addEventListener('click', () => {
            alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Firebase Configï¼");
        });
    }
</script>

<script>
    // --- éŠæˆ²é‚è¼¯ ---
    const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/karltpe/MikeEnglishTest/main/word_ad.json';
    const LEGENDARY_IDS = [144, 145, 146, 150, 151, 243, 244, 245, 249, 250, 382, 383, 384, 483, 484, 487, 493];
    
    function getRandomPokemonImage(isBoss) {
        let id;
        if (isBoss) {
            id = LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)];
        } else {
            do { id = Math.floor(Math.random() * 800) + 1; } while (LEGENDARY_IDS.includes(id));
        }
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
    }

    let wordList = [], battleQueue = [], currentEnemy = null, currentEnemyImgUrl = '';
    let selectedLetters = new Set();
    
    let playerMaxHp = 3, playerHp = 3;
    let pokeBalls = 0; 
    let caughtPokemon = [];
    
    let stageCount = 0; 
    let enemyMaxHp = 1, enemyCurrentHp = 1, isBossRound = false;
    let isFighting = false, isRevealed = false;

    const el = {
        levelGrid: document.getElementById('levelGrid'),
        enemyHpBar: document.getElementById('enemyHpBar'), enemyHpText: document.getElementById('enemyHpText'), enemyName: document.getElementById('enemyName'),
        playerHpBar: document.getElementById('playerHpBar'), playerHpText: document.getElementById('playerHpText'),
        enemyImg: document.getElementById('enemyImg'), playerImg: document.getElementById('playerImg'),
        questionBox: document.getElementById('questionBox'),
        qText: document.getElementById('qText'), qHint: document.getElementById('qHint'),
        input: document.getElementById('userInput'),
        btnAction: document.getElementById('btnAction'), btnRun: document.getElementById('btnRun'),
        btnVoiceWord: document.getElementById('btnVoiceWord'), btnVoiceSent: document.getElementById('btnVoiceSent'),
        msgBox: document.getElementById('msgBox'), scene: document.getElementById('battleScene'),
        gameFrame: document.getElementById('gameFrame'),
        rateSlider: document.getElementById('rateSlider'), ballCount: document.getElementById('ballCount'), stageInfo: document.getElementById('stageInfo'),
        btnShop: document.getElementById('btnShop'), shopModal: document.getElementById('shopModal'),
        btnBuyPotion: document.getElementById('btnBuyPotion'), btnCloseShop: document.getElementById('btnCloseShop'),
        btnBag: document.getElementById('btnBag'), bagModal: document.getElementById('bagModal'),
        pokedexGrid: document.getElementById('pokedexGrid'), emptyBagMsg: document.getElementById('emptyBagMsg'),
        btnPhoto: document.getElementById('btnPhoto'), btnCloseBag: document.getElementById('btnCloseBag'),
        bagContentArea: document.getElementById('bagContentArea')
    };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration, vol=0.1) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }
    const SFX = {
        attack: () => { playTone(600, 'sawtooth', 0.1); setTimeout(() => playTone(300, 'square', 0.1), 100); },
        hit: () => { playTone(100, 'sawtooth', 0.3); },
        error: () => { playTone(150, 'sawtooth', 0.2); setTimeout(() => playTone(100, 'sawtooth', 0.2), 150); },
        win: () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(500, 'sine', 0.1), 150); setTimeout(() => playTone(600, 'sine', 0.2), 300); },
        coin: () => { playTone(1000, 'sine', 0.1); setTimeout(() => playTone(1500, 'sine', 0.2), 100); }, 
        heal: () => { playTone(400, 'sine', 0.2); setTimeout(() => playTone(600, 'sine', 0.3), 200); },
        camera: () => { playTone(800, 'square', 0.1); },
        type: () => { playTone(800, 'triangle', 0.05, 0.05); },
        start: () => { playTone(300, 'square', 0.1); setTimeout(() => playTone(600, 'square', 0.3), 100); },
        bossStart: () => { playTone(100, 'sawtooth', 0.5); setTimeout(() => playTone(80, 'sawtooth', 0.5), 400); },
        btn: () => { playTone(400, 'sine', 0.1, 0.05); }
    };

    window.onload = async () => {
        const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        abc.forEach(char => {
            const b = document.createElement('div');
            b.className = 'lvl-btn';
            b.textContent = char;
            b.onclick = () => { SFX.btn(); toggleLevel(char, b); };
            el.levelGrid.appendChild(b);
        });

        try {
            el.msgBox.textContent = "æ­£åœ¨ä¸‹è¼‰å–®å­—åœ–é‘‘...";
            const res = await fetch(GITHUB_JSON_URL + '?t=' + Date.now());
            if(!res.ok) throw new Error("é€£ç·šå¤±æ•—");
            wordList = await res.json();
            el.msgBox.textContent = `âœ… æº–å‚™å®Œæˆï¼å…± ${wordList.length} å€‹å–®å­—ã€‚è«‹é¸é—œå¡ã€‚`;
            el.msgBox.style.color = "green";
        } catch(e) {
            el.msgBox.textContent = "âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
            el.msgBox.style.color = "red";
        }
    };

    el.btnShop.onclick = () => { SFX.btn(); el.shopModal.style.display = 'flex'; updateShopUI(); };
    el.btnCloseShop.onclick = () => { SFX.btn(); el.shopModal.style.display = 'none'; };
    el.btnBag.onclick = () => { SFX.btn(); el.bagModal.style.display = 'flex'; renderBag(); };
    el.btnCloseBag.onclick = () => { SFX.btn(); el.bagModal.style.display = 'none'; };

    el.btnBuyPotion.onclick = () => {
        if (pokeBalls >= 3 && playerHp < playerMaxHp) {
            pokeBalls -= 3; playerHp++; SFX.heal(); updateStats(); updateShopUI();
            el.msgBox.textContent = "ğŸ’– é«”åŠ›æ¢å¾©ï¼"; el.msgBox.style.color = "#e91e63";
        } else if (playerHp >= playerMaxHp) { alert("é«”åŠ›å·²ç¶“æ»¿äº†ï¼"); } 
        else { alert("ç²¾éˆçƒä¸å¤ å–”ï¼"); }
    };

    function updateShopUI() {
        el.btnBuyPotion.textContent = (playerHp >= playerMaxHp) ? "é«”åŠ›å·²æ»¿" : "è³¼è²· (3çƒ)";
        el.btnBuyPotion.disabled = (playerHp >= playerMaxHp || pokeBalls < 3);
    }

    function renderBag() {
        el.pokedexGrid.innerHTML = '';
        if (caughtPokemon.length === 0) {
            el.emptyBagMsg.style.display = 'block'; el.btnPhoto.style.display = 'none';
        } else {
            el.emptyBagMsg.style.display = 'none'; el.btnPhoto.style.display = 'block';
            caughtPokemon.forEach(p => {
                const card = document.createElement('div'); card.className = 'poke-card';
                card.innerHTML = `<img src="${p.img}"><div class="poke-name">${p.word}</div>`;
                el.pokedexGrid.appendChild(card);
            });
        }
    }

    el.btnPhoto.onclick = () => {
        SFX.camera(); el.btnPhoto.textContent = "ğŸ“· ç”¢ç”Ÿä¸­...";
        el.btnPhoto.style.visibility = 'hidden'; el.btnCloseBag.style.visibility = 'hidden';
        html2canvas(el.bagContentArea, { useCORS: true, scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            el.btnPhoto.style.visibility = 'visible'; el.btnCloseBag.style.visibility = 'visible';
            el.btnPhoto.textContent = "ğŸ“¸ åˆå½±ç•™å¿µ (ä¸‹è¼‰åœ–ç‰‡)";
            const link = document.createElement('a'); link.download = 'my-pokemon-collection.png';
            link.href = canvas.toDataURL(); link.click();
        });
    };

    function toggleLevel(char, btn) {
        if(isFighting || isRevealed) {
            if(!confirm("æˆ°é¬¥ä¸­åˆ‡æ›æœƒé‡ç½®é€²åº¦ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            resetGame();
        }
        if(selectedLetters.has(char)) { selectedLetters.delete(char); btn.classList.remove('active'); } 
        else { selectedLetters.add(char); btn.classList.add('active'); }
        if(selectedLetters.size > 0) {
            el.btnAction.textContent = "é–‹å§‹æˆ°é¬¥"; el.btnAction.disabled = false; el.btnAction.style.background = "#28a745";
            el.msgBox.textContent = `å·²é¸æ“‡ ${Array.from(selectedLetters).join(',')}ï¼ŒæŒ‰é–‹å§‹ï¼`;
        } else {
            el.btnAction.textContent = "è«‹é¸é—œå¡"; el.btnAction.disabled = true; el.btnAction.style.background = "#ccc";
        }
    }

    el.btnAction.onclick = () => {
        SFX.btn();
        if(!isFighting && !isRevealed) initBattle();
        else if(isFighting) playerAttack();
        else if(isRevealed) {
            if (isBossRound && enemyCurrentHp > 0) loadNextQuestion();
            else nextEnemy();
        }
    };

    el.btnRun.onclick = () => {
        if(!isFighting) return;
        SFX.error(); el.msgBox.textContent = "ğŸ’¨ é€ƒè·‘æˆåŠŸ (è·³é)"; el.msgBox.style.color = "orange";
        showDamage(0, true); revealAnswer(false);
    };

    el.input.addEventListener('keyup', (e) => {
        if(e.key === 'Enter' && !el.btnAction.disabled) el.btnAction.click();
    });
    el.input.addEventListener('input', () => { SFX.type(); });

    function initBattle() {
        const pool = wordList.filter(w => selectedLetters.has(w.word.charAt(0).toUpperCase()));
        if(pool.length === 0) { el.msgBox.textContent = "æ­¤é—œå¡æ²’æœ‰æ€ªç¸ï¼"; return; }
        SFX.start(); battleQueue = shuffle(pool); playerHp = playerMaxHp; stageCount = 0; updateStats();
        el.btnAction.style.background = "#ff3333"; nextEnemy();
    }

    function nextEnemy() {
        if(playerHp <= 0) { gameOver(false); return; }
        if(battleQueue.length === 0) { gameOver(true); return; }

        stageCount++; el.stageInfo.textContent = `é—œå¡ ${stageCount}`;
        isBossRound = (stageCount % 5 === 0);

        if (isBossRound) {
            enemyMaxHp = Math.floor(Math.random() * 3) + 8; enemyCurrentHp = enemyMaxHp;
            currentEnemyImgUrl = getRandomPokemonImage(true);
            el.scene.classList.add('boss-bg'); el.enemyImg.classList.add('boss-size');
            el.gameFrame.classList.add('boss-mode'); el.enemyHpBar.classList.add('hp-purple');
            el.enemyName.textContent = "å‚³èªªå¯¶å¯å¤¢ (é­”ç‹)"; SFX.bossStart();
            el.msgBox.textContent = "âš ï¸ è­¦å‘Šï¼å‚³èªªä¸­çš„å¯¶å¯å¤¢å‡ºç¾äº†ï¼"; el.msgBox.style.color = "#9c27b0";
        } else {
            enemyMaxHp = 1; enemyCurrentHp = 1;
            currentEnemyImgUrl = getRandomPokemonImage(false);
            el.scene.classList.remove('boss-bg'); el.enemyImg.classList.remove('boss-size');
            el.gameFrame.classList.remove('boss-mode'); el.enemyHpBar.classList.remove('hp-purple');
            el.enemyName.textContent = "é‡ç”Ÿå¯¶å¯å¤¢"; el.msgBox.textContent = "é‡ç”Ÿå¯¶å¯å¤¢å‡ºç¾äº†ï¼"; el.msgBox.style.color = "#333";
        }

        updateStats(); el.enemyImg.style.backgroundImage = `url('${currentEnemyImgUrl}')`;
        el.enemyImg.style.filter = "none"; el.playerImg.classList.remove('shake');
        loadNextQuestion();
    }

    function loadNextQuestion() {
        if (battleQueue.length === 0) { gameOver(true); return; }
        currentEnemy = battleQueue.shift();
        isFighting = true; isRevealed = false;

        el.input.value = ""; el.input.disabled = false; el.input.focus();
        const len = currentEnemy.word.length; el.input.placeholder = `${"_ ".repeat(len)} (${len})`;

        el.btnAction.textContent = "æ”»æ“Š (Enter)"; el.btnAction.disabled = false; el.btnAction.style.background = "#ff3333";
        el.btnRun.disabled = false; el.btnVoiceWord.disabled = false; el.btnVoiceSent.disabled = false;
        
        el.questionBox.innerHTML = `<div id="qText" class="q-word"></div><div id="qHint" class="q-hint"></div>`;
        el.qText = document.getElementById('qText'); el.qHint = document.getElementById('qHint');

        const type = currentEnemy.type ? `(${currentEnemy.type})` : "";
        el.qText.textContent = `${currentEnemy.cn_word} ${type}`;
        
        let maskedSent = "";
        if(currentEnemy.sentence) {
            const reg = new RegExp(currentEnemy.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            maskedSent = currentEnemy.sentence.replace(reg, '____');
        }
        el.qHint.textContent = maskedSent;
    }

    function playerAttack() {
        const ans = el.input.value.trim().toLowerCase();
        const correct = currentEnemy.word.trim().toLowerCase();

        if(ans === correct) {
            SFX.attack(); el.playerImg.classList.add('attack-anim');
            setTimeout(() => el.playerImg.classList.remove('attack-anim'), 300);
            
            setTimeout(() => {
                SFX.hit(); enemyCurrentHp--; showDamage(1, false); updateStats();
                el.enemyImg.style.filter = "brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5)";
                setTimeout(() => { if (enemyCurrentHp > 0) el.enemyImg.style.filter = "none"; }, 300);

                if (enemyCurrentHp <= 0) {
                    enemyCurrentHp = 0; pokeBalls++;
                    caughtPokemon.push({ word: currentEnemy.word, img: currentEnemyImgUrl }); SFX.coin();
                    el.msgBox.textContent = isBossRound ? "âœ¨ å‚³èªªå¯¶å¯å¤¢æ”¶æœæˆåŠŸï¼" : "ğŸ’¥ æˆåŠŸæ”¶æœï¼";
                    el.msgBox.style.color = "green"; el.enemyImg.style.filter = "brightness(0) opacity(0.5)";
                } else {
                    el.msgBox.textContent = `âš”ï¸ æ”»æ“Šå‘½ä¸­ï¼é­”ç‹é‚„å‰© ${enemyCurrentHp} é»è¡€ï¼`; el.msgBox.style.color = "blue";
                }
                updateStats(); revealAnswer(true);
            }, 200);
            speak(currentEnemy.word);
        } else {
            SFX.error(); playerHp--; updateStats();
            el.playerImg.classList.add('shake'); setTimeout(() => el.playerImg.classList.remove('shake'), 500);
            showDamage(1, true);
            if(playerHp <= 0) { setTimeout(() => gameOver(false), 1000); } 
            else { el.msgBox.textContent = "âŒ æ”»æ“Šå¤±èª¤ï¼å—åˆ°åæ“Šï¼"; el.msgBox.style.color = "red"; el.input.value = ""; el.input.focus(); }
        }
    }

    function revealAnswer(isWin) {
        isFighting = false; isRevealed = true;
        el.input.disabled = true; el.btnRun.disabled = true;
        if (enemyCurrentHp > 0) el.btnAction.textContent = "ä¸‹ä¸€é¡Œ (ç¹¼çºŒæˆ°é¬¥)";
        else el.btnAction.textContent = "ä¸‹ä¸€éš»æ€ªç¸";
        el.btnAction.style.background = "#2196f3";
        el.qText.innerHTML = `<span style="color:red; font-size:1.2em;">${currentEnemy.word}</span> <span style="font-size:0.6em; color:#666;">${currentEnemy.KK||''}</span>`;
        if(currentEnemy.sentence) el.qHint.textContent = currentEnemy.sentence;
    }

    function showDamage(amount, isPlayerHurt) {
        const dmg = document.createElement('div'); dmg.className = 'damage-text';
        dmg.textContent = `-${amount}`; dmg.style.color = isPlayerHurt ? 'red' : 'orange';
        if(isPlayerHurt) { dmg.style.left = "60px"; dmg.style.bottom = "100px"; } 
        else { dmg.style.right = "60px"; dmg.style.top = "50px"; }
        el.scene.appendChild(dmg); setTimeout(() => dmg.remove(), 800);
    }

    function updateStats() {
        const ePct = (enemyCurrentHp / enemyMaxHp) * 100;
        el.enemyHpBar.style.width = ePct + "%"; el.enemyHpText.textContent = `${enemyCurrentHp}/${enemyMaxHp}`;
        const pPct = (playerHp / playerMaxHp) * 100;
        el.playerHpBar.style.width = pPct + "%"; el.playerHpText.textContent = `${playerHp}/${playerMaxHp}`;
        el.playerHpBar.className = "hp-bar-fill " + (pPct > 50 ? "hp-green" : pPct > 20 ? "hp-yellow" : "hp-red");
        el.ballCount.textContent = pokeBalls;
    }

    function gameOver(isClear) {
        isFighting = false; isRevealed = false;
        el.btnAction.textContent = "é‡æ–°æŒ‘æˆ°"; el.btnAction.style.background = "#28a745";
        el.btnAction.disabled = false; el.input.disabled = true;
        if(isClear) {
            SFX.win();
            el.questionBox.innerHTML = `<div style="font-size: 2em;">ğŸ†</div><div class="game-over-title">æ­å–œé€šé—œï¼</div><div class="game-over-desc">ä½ æ˜¯å¯¶å¯å¤¢å¤§å¸«ï¼</div>`;
            el.msgBox.textContent = "å¤ªå¼·äº†ï¼";
        } else {
            SFX.error();
            el.questionBox.innerHTML = `<div style="font-size: 3em; margin-bottom:5px;">ğŸ’€</div><div style="color: #2a75bb; font-size: 1.8em; font-weight: bold; margin-bottom: 5px;">çœ¼å‰ä¸€ç‰‡æ¼†é»‘...</div><div style="color: #666; font-size: 1em;">è¨“ç·´å®¶å€’ä¸‹äº†ï¼Œè«‹é‡æ–°æŒ‘æˆ°ï¼</div>`;
            el.msgBox.textContent = "æˆ°æ•—...";
        }
    }

    function resetGame() {
        isFighting = false; isRevealed = false;
        selectedLetters.clear();
        document.querySelectorAll('.lvl-btn.active').forEach(b => b.classList.remove('active'));
        el.btnAction.textContent = "è«‹é¸é—œå¡"; el.btnAction.disabled = true; el.btnAction.style.background = "#ccc";
        el.questionBox.innerHTML = `<div id="qText" class="q-word">è«‹å…ˆé¸æ“‡ä¸Šæ–¹é—œå¡</div><div id="qHint" class="q-hint"></div>`;
        el.qText = document.getElementById('qText'); el.qHint = document.getElementById('qHint');
        enemyHp = 100; playerHp = 3; updateStats();
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = parseFloat(el.rateSlider.value);
            window.speechSynthesis.speak(u);
        }
    }
    
    el.btnVoiceWord.onclick = () => { if(currentEnemy) speak(currentEnemy.word); };
    el.btnVoiceSent.onclick = () => { if(currentEnemy && currentEnemy.sentence) speak(currentEnemy.sentence); };

</script>
</body>
</html>
