<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢å–®å­— RPG (Fix Edition)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #87CEEB;
            --primary-color: #FFCB05;
            --secondary-color: #2a75bb;
            --danger-color: #ff3333;
            --success-color: #4caf50;
            --boss-color: #673ab7;
            --font-main: 'Comic Sans MS', 'Microsoft JhengHei', sans-serif;
        }

        * { box-sizing: border-box; } 

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            -webkit-tap-highlight-color: transparent; 
        }

        /* --- ç™»å…¥é®ç½© --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; backdrop-filter: blur(5px); padding: 20px;
        }
        .login-card {
            background: white; padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 0 30px rgba(255, 203, 5, 0.6); border: 5px solid var(--primary-color);
            width: 100%; max-width: 400px;
        }
        .btn-google-login {
            background-color: #4285F4; color: white; border: none; padding: 12px 20px;
            border-radius: 50px; font-size: 1.1em; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 10px; width: 100%;
            margin-top: 15px;
        }

        /* --- éŠæˆ²ä¸»æ¡†æ¶ --- */
        #gameWrapper {
            display: none; width: 100%; max-width: 600px; 
            flex-direction: column; align-items: center;
        }

        .game-frame {
            width: 100%;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            border: 4px solid var(--secondary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 15px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.5s;
        }
        .game-frame.boss-mode { border-color: var(--boss-color); box-shadow: 0 0 15px var(--boss-color); }

        /* --- é ‚éƒ¨è³‡è¨Š --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; background: #f0f0f0; padding: 8px 12px;
            border-radius: 12px; font-size: 0.9em;
        }
        .user-profile { display: flex; align-items: center; gap: 5px; color: #555; font-weight: bold; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; }
        
        .currency-box { display: flex; align-items: center; gap: 3px; font-weight: bold; color: #333; }
        .ball-icon { width: 20px; height: 20px; }
        
        .menu-btns { display: flex; gap: 5px; }
        .btn-top {
            color: white; border: none; padding: 6px 10px; border-radius: 15px;
            font-weight: bold; cursor: pointer; font-size: 0.85em;
        }
        .btn-shop { background: #9c27b0; }
        .btn-bag { background: #ff5722; }

        /* --- æˆ°é¬¥å ´æ™¯ --- */
        .battle-scene {
            height: 240px; background: #e0f7fa; border-radius: 15px; border: 3px solid #333;
            position: relative; margin-bottom: 15px;
            background-image: radial-gradient(circle at 50% 120%, #81c784 40%, transparent 40%); 
            transition: filter 0.5s; overflow: hidden; 
        }
        .battle-scene.boss-bg { filter: hue-rotate(240deg); }

        /* è¡€æ¢ */
        .hp-box {
            position: absolute; background: #fff; border: 2px solid #333; border-radius: 8px;
            padding: 4px 8px; width: 120px; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); z-index: 10;
        }
        .hp-label { font-size: 0.75em; font-weight: bold; display: flex; justify-content: space-between; white-space: nowrap; overflow: hidden;}
        .hp-bar-bg { width: 100%; height: 6px; background: #555; border-radius: 3px; margin-top: 2px; }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.3s ease-out; }
        .hp-green { background: #4caf50; } .hp-red { background: #f44336; } .hp-purple { background: #9c27b0; } 

        .player-hud { top: 15px; left: 15px; }
        .enemy-hud { bottom: 15px; right: 15px; width: 140px; }

        /* è§’è‰²åœ–ç‰‡ (ä¿®æ­£ç‰ˆï¼šå¼·åˆ¶é™åˆ¶å¤§å°) */
        .enemy-pos { 
            position: absolute; top: 40px; right: 30px; 
            width: 120px; height: 120px; /* å›ºå®šå®¹å™¨å¤§å° */
            display: flex; justify-content: center; align-items: center;
        }
        .enemy-img {
            width: 100%; height: 100%;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            transition: all 0.5s; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }
        .enemy-img.boss-size { transform: scale(1.3); filter: drop-shadow(0 0 15px var(--boss-color)); }

        .player-pos { 
            position: absolute; bottom: 10px; left: 30px; 
            width: 110px; height: 110px; /* å›ºå®šå®¹å™¨å¤§å° */
        }
        .player-img { 
            width: 100%; height: 100%; 
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/25.png'); 
            background-size: contain; background-repeat: no-repeat; background-position: bottom; 
            transform: scale(1.6); transform-origin: bottom center;
        }

        /* --- ç‰¹æ•ˆ --- */
        .damage-text { position: absolute; font-size: 2em; font-weight: 900; color: #ff3333; text-shadow: 2px 2px 0 #fff; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 20; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.2); opacity: 0; } }
        .shake { animation: shakeAnim 0.5s; }
        @keyframes shakeAnim { 0% { transform: translate(0, 0); } 25% { transform: translate(-8px, 0); filter: hue-rotate(90deg); } 50% { transform: translate(8px, 0); } 75% { transform: translate(-8px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        .attack-anim { animation: lunge 0.2s forwards; }
        @keyframes lunge { 50% { transform: translateX(40px) scale(1.1); } }
        .levelup-anim { animation: jump 0.5s ease-in-out 3; filter: drop-shadow(0 0 10px gold); }
        @keyframes jump { 0%, 100% { transform: scale(1.6) translateY(0); } 50% { transform: scale(1.6) translateY(-20px); } }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .control-panel { text-align: center; }
        
        .question-box {
            background: #fff; padding: 10px; border-radius: 10px; border: 2px dashed #aaa;
            margin-bottom: 15px; min-height: 80px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .q-word { font-size: 1.6em; color: var(--secondary-color); font-weight: bold; line-height: 1.2; }
        .q-hint { color: #666; font-size: 0.9em; margin-top: 5px; line-height: 1.3; }

        .game-over-title { color: #2a75bb; font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        
        /* è¼¸å…¥å€ */
        .input-area { 
            display: flex; gap: 8px; justify-content: center; margin-bottom: 12px; flex-wrap: wrap; 
        }
        #userInput {
            padding: 12px; font-size: 1.2em; border: 3px solid #ccc; border-radius: 12px;
            width: 100%; text-align: center; font-weight: bold; font-family: monospace;
            color: #333; background: #fff;
        }
        #userInput:focus { border-color: var(--primary-color); outline: none; }

        .btn-group { display: flex; gap: 8px; width: 100%; }
        .btn {
            border: none; border-radius: 10px; padding: 12px;
            font-size: 1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; color: white;
            flex: 1; 
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:disabled { background: #ccc !important; box-shadow: none !important; cursor: not-allowed; opacity: 0.7; }
        .btn-atk { background: var(--success-color); }
        .btn-run { background: #ff9800; }
        
        .voice-controls { display: flex; justify-content: center; gap: 8px; align-items: center; margin-bottom: 10px; }
        .btn-voice { background: #2196f3; padding: 8px 12px; font-size: 0.9em; min-width: auto; }

        /* é—œå¡æ ¼å­ */
        .level-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(32px, 1fr));
            gap: 4px; margin-bottom: 15px;
        }
        .lvl-btn {
            background: #fff; border: 2px solid var(--secondary-color); color: var(--secondary-color);
            border-radius: 6px; padding: 6px 0; font-weight: bold; cursor: pointer; text-align: center;
            font-size: 0.9em;
        }
        .lvl-btn.active { background: var(--primary-color); color: #333; border-color: #333; }
        .lvl-btn.has-review { position: relative; border-color: red; color: red; }

        .msg-box { height: 25px; font-weight: bold; color: #333; margin-top: 5px; font-size: 0.95em; }
        
        /* --- å½ˆçª—ç³»çµ± --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background: #fff; padding: 15px; border-radius: 15px; width: 100%; max-width: 400px;
            max-height: 90vh; overflow-y: auto; text-align: center; border: 4px solid #fff;
            position: relative;
        }
        .shop-content { border-color: #9c27b0; }
        .bag-content { border-color: #ff5722; }

        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #f3e5f5; padding: 12px; border-radius: 10px; margin: 10px 0;
            border: 2px solid #e1bee7;
        }
        .btn-buy { background: #9c27b0; padding: 8px 16px; font-size: 0.9em; border-radius: 20px; color: white; border: none; font-weight: bold;}

        /* --- èƒŒåŒ…ç³»çµ± --- */
        .bag-tools {
            display: flex; gap: 5px; margin-bottom: 10px; justify-content: center;
        }
        .bag-search {
            flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.9em;
        }
        .btn-sort {
            background: #607d8b; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 0.8em;
        }

        .pokedex-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            margin-top: 10px; padding: 5px;
        }
        
        .poke-card {
            background: #fbe9e7; border: 1px solid #ffccbc; border-radius: 8px;
            padding: 5px; display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        .poke-card img { width: 50px; height: 50px; object-fit: contain; }
        .poke-name { font-size: 0.75em; font-weight: bold; color: #e91e63; margin-top: 2px; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .poke-word { font-size: 0.6em; color: #888; }
        
        .count-badge {
            position: absolute; top: 2px; right: 2px;
            background-color: #d32f2f; color: white; font-size: 0.7em; font-weight: bold;
            padding: 1px 5px; border-radius: 10px; box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .level-badge {
            position: absolute; top: 2px; left: 2px;
            background-color: #4caf50; color: white;
            font-size: 0.6em; font-weight: bold;
            padding: 1px 4px; border-radius: 4px;
        }
        
        .pagination-controls {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            margin-top: 15px; font-weight: bold; color: #555;
        }
        .btn-page {
            background: #ff5722; color: white; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; font-weight: bold;
        }
        .btn-page:disabled { background: #ccc; }
        .page-input {
            width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 5px; padding: 3px; font-weight: bold;
        }

        .btn-photo { background: #00bcd4; width: 100%; margin-top: 15px; padding: 12px; border-radius: 10px; color: white; border: none; font-weight: bold; font-size: 1em; cursor: pointer;}
        .btn-close { background: #666; margin-top: 10px; padding: 8px 20px; border-radius: 20px; color: white; border: none; font-weight: bold; cursor: pointer;}

        .hidden { display: none !important; }

        @media (max-width: 480px) {
            h1 { font-size: 1.4em; margin-bottom: 10px; }
            .battle-scene { height: 180px; } 
            .enemy-pos { top: 25px; right: 10px; width: 100px; height: 100px; }
            .player-pos { bottom: 5px; left: 10px; width: 100px; height: 100px; }
            .input-group { flex-direction: column; }
            .voice-controls button, .voice-controls input { flex: 1; }
            .rate-controls { display: none; } 
            .pokedex-grid { grid-template-columns: repeat(3, 1fr); } 
            .poke-card img { width: 40px; height: 40px; }
        }
		
		/* --- éå ´å‹•ç•« (Splash Screen) - å…¨è¢å¹•è¿è³“ç‰ˆ --- */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000;
            display: none; /* é è¨­éš±è— */
            justify-content: center; align-items: center;
            flex-direction: column;
            transition: opacity 0.8s ease-out;
            
            /* --- èƒŒæ™¯è¨­å®šæ ¸å¿ƒ --- */
            /* é€™è£¡è«‹æ›æˆæ‚¨çš„ GitHub åœ–ç‰‡ Raw é€£çµ */
            background-image: url('https://raw.githubusercontent.com/karltpe/pokemongame/1aea82ed221fbf4721f97066081951ec433e00cb/openning.jpg'); 
            background-size: cover;      /* ç¢ºä¿åœ–ç‰‡å¡«æ»¿æ•´å€‹è¢å¹•ï¼Œä¸æœƒè®Šå½¢ä½†å¯èƒ½æœƒè¢«è£åˆ‡ */
            background-position: center; /* åœ–ç‰‡ç½®ä¸­å°é½Š */
            background-repeat: no-repeat;

            /* åŠ ä¸Šä¸€å±¤åŠé€æ˜é»‘è‰²é®ç½©ï¼Œè®“æ–‡å­—æ›´æ¸…æ¥šï¼Œæ›´æœ‰è³ªæ„Ÿ */
            box-shadow: inset 0 0 0 2000px rgba(0, 0, 0, 0.5); 
            color: white; /* å°‡æ•´é«”æ–‡å­—æ”¹ç‚ºç™½è‰² */
        }

        /* å…§å®¹å®¹å™¨ */
        .splash-content {
            text-align: center;
            opacity: 0;
            transform: scale(0.8) translateY(30px); /* åˆå§‹ç‹€æ…‹ç¨å¾®å°ä¸€é»ä¸”åœ¨ä¸‹æ–¹ */
        }

        /* "å„ªé›…æµ®ç¾"å‹•ç•« */
        .splash-pop-in {
            animation: floatInAnim 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes floatInAnim {
            0% { opacity: 0; transform: scale(0.8) translateY(30px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* "æ·¡å‡º" Class */
        .splash-fade-out { opacity: 0; pointer-events: none; }

        /* ç§»é™¤åŸæœ¬çš„æ—‹è½‰çƒæ¨£å¼ï¼Œèª¿æ•´é ­åƒå’Œæ–‡å­— */
        .splash-avatar {
            width: 110px; height: 110px; border-radius: 50%;
            border: 4px solid white; /* é‚Šæ¡†æ”¹ç™½è‰² */
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); /* åŠ å¼·é™°å½± */
            margin-bottom: 15px;
        }
        #splashWelcome { 
            color: white; /* æ–‡å­—æ”¹ç™½è‰² */
            font-size: 2em; margin: 5px 0; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* åŠ ä¸Šæ–‡å­—é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
        }
		
		
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div style="font-size: 3em; margin-bottom: 10px;">âš¡</div>
        <h2 style="margin: 0 0 20px 0; color: #2a75bb;">å¯¶å¯å¤¢å–®å­—å¤§å†’éšª</h2>
        <button id="btnGoogleLogin" class="btn-google-login">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24" height="24">
            Google ç™»å…¥
        </button>
        <p style="margin-top: 20px; color: #666; font-size: 0.85em;">
            è«‹ä½¿ç”¨ Live Server é–‹å•Ÿ<br>ç™»å…¥å¾Œç´€éŒ„å†’éšªé€²åº¦
        </p>
    </div>
</div>

</div> <div id="splashScreen">
    <div class="splash-content" id="splashContent">
        <img id="splashAvatar" class="splash-avatar" src="">
        <h2 id="splashWelcome">æ­¡è¿å›ä¾†!</h2>
        <p style="color:#666; font-size:0.9em;">å†’éšªæº–å‚™ä¸­...</p>
    </div>
</div>

<div id="gameWrapper" style="display: none;">
    <div class="game-frame" id="gameFrame">
        <div class="top-bar">
            <div class="user-profile">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                <span id="userNameDisplay" style="max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">è¨“ç·´å®¶</span>
                <button id="btnLogout" style="background:none; border:none; font-size:1.2em; cursor:pointer;">ğŸšª</button>
            </div>
            <div class="currency-box">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="ball-icon" alt="Ball">
                x <span id="ballCount">0</span>
            </div>
            <div class="menu-btns">
                <button class="btn-top btn-bag" id="btnBag">ğŸ’</button>
                <button class="btn-top btn-shop" id="btnShop">ğŸ›’</button>
            </div>
        </div>

        <div class="level-grid" id="levelGrid"></div>

        <div class="battle-scene" id="battleScene">
            <div class="hp-box enemy-hud">
                <div class="hp-label"><span id="enemyName">é‡ç”Ÿæ€ªç¸</span> <span id="enemyHpText">100%</span></div>
                <div class="hp-bar-bg"><div class="hp-bar-fill hp-red" id="enemyHpBar"></div></div>
            </div>
            <div class="enemy-pos"><div class="enemy-img" id="enemyImg"></div></div>

            <div class="hp-box player-hud">
                <div class="hp-label">
                    <span id="playerName">è¨“ç·´å®¶</span> 
                    <span id="playerLevelText" style="color:var(--secondary-color);">Lv.1</span>
                </div>
                <div class="hp-bar-bg"><div class="hp-bar-fill hp-green" id="playerHpBar"></div></div>
                <div style="width:100%; height:4px; background:#ddd; border-radius:2px; margin-top:2px;">
                    <div id="playerExpBar" style="height:100%; width:0%; background:#00bcd4; transition:width 0.3s;"></div>
                </div>
            </div>
            <div class="player-pos"><div class="player-img" id="playerImg"></div></div>
        </div>

        <div class="control-panel">
            <div class="question-box" id="questionBox">
                <div id="qText" class="q-word">è«‹å…ˆé¸æ“‡ä¸Šæ–¹é—œå¡</div>
                <div id="qHint" class="q-hint"></div>
            </div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="è«‹é»æ­¤è¼¸å…¥..." disabled autocomplete="off" autocapitalize="off">
            </div>
            <div class="input-area btn-group">
                <button class="btn btn-atk" id="btnAction" disabled>æ”»æ“Š</button>
                <button class="btn btn-run" id="btnRun" disabled>é€ƒè·‘</button>
            </div>

            <div class="voice-controls">
                <button class="btn btn-voice" id="btnVoiceWord" disabled>ğŸ”Š å–®å­—</button>
                <button class="btn btn-voice" id="btnVoiceSent" disabled>ğŸ”Š ä¾‹å¥</button>
                <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="1.0" title="èªé€Ÿ" style="width: 70px;">
            </div>
            
            <div class="msg-box" id="msgBox">æº–å‚™æˆ°é¬¥ï¼</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="shopModal">
    <div class="modal-content shop-content">
        <h2 style="margin:0 0 10px 0; color:#9c27b0;">å¯¶å¯å¤¢ä¸­å¿ƒå•†åº—</h2>
        <div class="shop-item">
            <div style="text-align:left;">
                <div style="font-weight:bold;">ğŸ’– å…¨æ»¿è—¥</div>
                <div style="font-size:0.8em; color:#666;">å›å¾© 1 é»ç”Ÿå‘½å€¼</div>
            </div>
            <div style="text-align:right;">
                <div class="shop-price">3 çƒ</div>
                <button class="btn btn-buy" id="btnBuyPotion">è³¼è²·</button>
            </div>
        </div>
        <button class="btn-close" id="btnCloseShop">é›¢é–‹</button>
    </div>
</div>

<div class="modal-overlay" id="bagModal">
    <div class="modal-content bag-content" id="bagContentArea">
        <h3 style="margin:0 0 5px 0; color:#ff5722;">æˆ‘çš„å¯¶å¯å¤¢èƒŒåŒ…</h3>
        <div style="font-size:0.9em; color:#666; margin-bottom:10px;">å·²æ”¶æœ: <span id="totalCaught">0</span> éš»</div>
        
        <div class="bag-tools">
            <input type="text" id="bagSearch" class="bag-search" placeholder="æœå°‹å¯¶å¯å¤¢...">
            <button class="btn-sort" id="btnSort">æ’åº: æœ€æ–°</button>
        </div>

        <div id="pokedexGrid" class="pokedex-grid"></div>
        <p id="emptyBagMsg" style="color:#888; display:none;">é‚„æ²’æŠ“åˆ°ä»»ä½•å¯¶å¯å¤¢ã€‚</p>
        
        <div class="pagination-controls" id="bagPagination" style="display:none;">
            <button class="btn-page" id="btnPrevPage">â®</button>
            <input type="number" id="pageInput" class="page-input" value="1" min="1">
            <span id="totalPagesText">/ 1</span>
            <button class="btn-page" id="btnNextPage">â¯</button>
        </div>

        <button class="btn-photo" id="btnPhoto">ğŸ“¸ è£½ä½œæˆ°ç¸¾å¡</button>
        <button class="btn-close" id="btnCloseBag">é—œé–‰</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ***************************************************************
    // âš ï¸ è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ CONFIG
    // ***************************************************************
    const firebaseConfig = {
		apiKey: "AIzaSyDob5OyYtOjTXCK16iu741sn6KX-rNWa-Q",
		authDomain: "gept-pokemon-game.firebaseapp.com",
		projectId: "gept-pokemon-game",
		storageBucket: "gept-pokemon-game.firebasestorage.app",
		messagingSenderId: "345364092934",
		appId: "1:345364092934:web:57a18217cdd874c4ed0b87",
		measurementId: "G-NJ756ZPF8M"
    };

    let auth, db, userRef;
    try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch(e) { console.error(e); }

    const overlay = document.getElementById('loginOverlay');
    const gameWrapper = document.getElementById('gameWrapper');
    const btnGoogleLogin = document.getElementById('btnGoogleLogin');
    const btnLogout = document.getElementById('btnLogout');
    const userAvatar = document.getElementById('userAvatar');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const playerName = document.getElementById('playerName');

    if (auth && db) {
        btnGoogleLogin.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch((error) => alert("ç™»å…¥å¤±æ•—: " + error.message));
        });

        btnLogout.addEventListener('click', () => {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) signOut(auth).then(() => location.reload());
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        name: user.displayName, email: user.email, photo: user.photoURL,
                        isApproved: false, role: "user", 
                        pokeBalls: 0, pokemonBag: [], mistakes: [], playerLevel: 1, playerExp: 0,
                        createdAt: new Date().toISOString()
                    });
                    alert("è¨»å†ŠæˆåŠŸï¼ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚");
                    await signOut(auth);
                } else {
                    const data = userSnap.data();
                    if (data.isApproved) {
                       // 1. éš±è—ç™»å…¥é®ç½©
                        overlay.style.display = 'none';
                        
                        // 2. æº–å‚™éå ´å‹•ç•«è³‡æ–™
                        const splashScreen = document.getElementById('splashScreen');
                        const splashContent = document.getElementById('splashContent');
                        document.getElementById('splashAvatar').src = data.photo;
                        document.getElementById('splashWelcome').textContent = `æ­¡è¿å›ä¾†, ${data.name}!`;

                        // 3. é¡¯ç¤ºéå ´ä¸¦è§¸ç™¼ã€Œç‚¸å‡ºä¾†ã€å‹•ç•«
                        splashScreen.style.display = 'flex';
                        // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ªï¼Œç¢ºä¿å‹•ç•«æœƒé‡æ–°è§¸ç™¼
                        void splashContent.offsetWidth; 
                        splashContent.classList.add('splash-pop-in');

                        // 4. åœ¨èƒŒæ™¯åŒæ­¥æ›´æ–°éŠæˆ²ä»‹é¢è³‡æ–™
                        userNameDisplay.textContent = data.name;
                        playerName.textContent = data.name;
                        userAvatar.src = data.photo;
                        window.playerData.pokeBalls = data.pokeBalls || 0;
                        window.playerData.pokemonBag = data.pokemonBag || [];
                        window.playerData.mistakes = data.mistakes || [];
                        window.playerData.level = data.playerLevel || 1;
                        window.playerData.exp = data.playerExp || 0;
                        window.updateUIFromCloud();

                        // 5. ç­‰å¾… 2 ç§’å¾Œé–‹å§‹æ·¡å‡ºï¼Œå†åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
                        setTimeout(() => {
                            // é–‹å§‹æ·¡å‡º
                            splashScreen.classList.add('splash-fade-out');
                            
                            // ç­‰å¾…æ·¡å‡ºå‹•ç•«çµæŸ (0.8ç§’) å¾Œï¼Œå®Œå…¨éš±è—éå ´ä¸¦é¡¯ç¤ºéŠæˆ²
                            setTimeout(() => {
                                splashScreen.style.display = 'none';
                                splashScreen.classList.remove('splash-fade-out'); // æ¸…ç† class
                                splashContent.classList.remove('splash-pop-in'); // æ¸…ç† class
                                gameWrapper.style.display = 'flex'; // é¡¯ç¤ºéŠæˆ²ä¸»ç•«é¢
                            }, 800); // é€™å€‹æ™‚é–“è¦é…åˆ CSS çš„ transition: opacity 0.8s

                        }, 2000); // éå ´ç•«é¢åœç•™æ™‚é–“ (2ç§’)
                    } else {
                        alert("å°šæœªé€šéå¯©æ ¸ã€‚");
                        await signOut(auth);
                    }
                }
            } else {
                overlay.style.display = 'flex';
                gameWrapper.style.display = 'none';
            }
        });
    }

    window.saveCloudData = async (type, payload) => {
        if (!userRef) return;
        try {
            // æ¯æ¬¡éƒ½æ›´æ–°ç‹€æ…‹
            const updateObj = {
                pokeBalls: window.playerData.pokeBalls,
                playerLevel: window.playerData.level,
                playerExp: window.playerData.exp
            };

            if (type === 'catch_pokemon') {
                await updateDoc(userRef, { 
                    ...updateObj,
                    pokemonBag: arrayUnion(payload.pokemon),
                    mistakes: arrayRemove(payload.word)
                });
            } else if (type === 'add_mistake') {
                await updateDoc(userRef, { 
                    ...updateObj,
                    mistakes: arrayUnion(payload.word) 
                });
            } else {
                // åªæ˜¯æ›´æ–°æ•¸å€¼ (å¦‚è²·è—¥æ°´)
                await updateDoc(userRef, updateObj);
            }
        } catch (e) { console.error("å­˜æª”å¤±æ•—", e); }
    };
</script>

<script>
    const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/karltpe/MikeEnglishTest/main/word_ad.json';
    const LEGENDARY_IDS = [144, 145, 146, 150, 151, 243, 244, 245, 249, 250, 382, 383, 384, 483, 484, 487, 493];
    
    window.playerData = { pokeBalls: 0, pokemonBag: [], mistakes: [], level: 1, exp: 0 };
    const getMaxExp = (lvl) => lvl * 100;

    // --- èƒŒåŒ…åˆ†é /æœå°‹/æ’åº ---
    const ITEMS_PER_PAGE = 9;
    let currentBagPage = 1;
    let bagSortOrder = 'newest'; 
    let bagSearchTerm = '';
    
    // åç¨±å¿«å–
    const pokemonNameCache = {};
    async function fetchPokemonName(id) {
        if (pokemonNameCache[id]) return pokemonNameCache[id];
        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
            if(!res.ok) return "æœªçŸ¥å¯¶å¯å¤¢";
            const data = await res.json();
            const nameObj = data.names.find(n => n.language.name === 'zh-Hant');
            const name = nameObj ? nameObj.name : data.name;
            pokemonNameCache[id] = name;
            return name;
        } catch(e) { return "ç¥ç§˜æ€ªç¸"; }
    }

    function getRandomPokemonId(isBoss) {
        let id;
        const ownedIds = new Set(window.playerData.pokemonBag.map(p => p.speciesId));
        let foundNew = false;
        // é™ä½ã€Œæ–°æ€ªæ©Ÿç‡ã€ä»¥é¿å…å¡ä½
        for(let i=0; i<15; i++) { 
             if (isBoss) id = LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)];
             else do { id = Math.floor(Math.random() * 800) + 1; } while (LEGENDARY_IDS.includes(id));
             if(!ownedIds.has(id)) { foundNew = true; break; }
        }
        if(!foundNew || !id) id = Math.floor(Math.random() * 800) + 1;
        return id;
    }

    let wordList = [], battleQueue = [], currentEnemy = null, currentEnemyImgUrl = '', currentEnemyName = '', currentEnemyId = 0;
    let selectedLetters = new Set();
    let playerMaxHp = 3, playerHp = 3, stageCount = 0, enemyMaxHp = 1, enemyCurrentHp = 1, isBossRound = false;
    let isFighting = false, isRevealed = false;

    const el = {
        levelGrid: document.getElementById('levelGrid'),
        enemyHpBar: document.getElementById('enemyHpBar'), enemyHpText: document.getElementById('enemyHpText'), enemyName: document.getElementById('enemyName'),
        playerHpBar: document.getElementById('playerHpBar'), playerHpText: document.getElementById('playerHpText'),
        playerExpBar: document.getElementById('playerExpBar'), playerLevelText: document.getElementById('playerLevelText'),
        enemyImg: document.getElementById('enemyImg'), playerImg: document.getElementById('playerImg'),
        questionBox: document.getElementById('questionBox'), qText: document.getElementById('qText'), qHint: document.getElementById('qHint'),
        input: document.getElementById('userInput'),
        btnAction: document.getElementById('btnAction'), btnRun: document.getElementById('btnRun'),
        btnVoiceWord: document.getElementById('btnVoiceWord'), btnVoiceSent: document.getElementById('btnVoiceSent'),
        msgBox: document.getElementById('msgBox'), scene: document.getElementById('battleScene'),
        gameFrame: document.getElementById('gameFrame'), ballCount: document.getElementById('ballCount'),
        btnShop: document.getElementById('btnShop'), shopModal: document.getElementById('shopModal'),
        btnBuyPotion: document.getElementById('btnBuyPotion'), btnCloseShop: document.getElementById('btnCloseShop'),
        btnBag: document.getElementById('btnBag'), bagModal: document.getElementById('bagModal'),
        pokedexGrid: document.getElementById('pokedexGrid'), emptyBagMsg: document.getElementById('emptyBagMsg'),
        btnPhoto: document.getElementById('btnPhoto'), btnCloseBag: document.getElementById('btnCloseBag'),
        bagContentArea: document.getElementById('bagContentArea'),
        totalCaught: document.getElementById('totalCaught'),
        rateSlider: document.getElementById('rateSlider'),
        // èƒŒåŒ…æ§åˆ¶
        bagPagination: document.getElementById('bagPagination'),
        btnPrevPage: document.getElementById('btnPrevPage'),
        btnNextPage: document.getElementById('btnNextPage'),
        pageInput: document.getElementById('pageInput'),
        totalPagesText: document.getElementById('totalPagesText'),
        bagSearch: document.getElementById('bagSearch'),
        btnSort: document.getElementById('btnSort')
    };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration, vol=0.1) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
    }
    const SFX = {
        attack: () => { playTone(600, 'sawtooth', 0.1); setTimeout(() => playTone(300, 'square', 0.1), 100); },
        hit: () => { playTone(100, 'sawtooth', 0.3); },
        error: () => { playTone(150, 'sawtooth', 0.2); setTimeout(() => playTone(100, 'sawtooth', 0.2), 150); },
        win: () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(500, 'sine', 0.1), 150); setTimeout(() => playTone(600, 'sine', 0.2), 300); },
        coin: () => { playTone(1000, 'sine', 0.1); setTimeout(() => playTone(1500, 'sine', 0.2), 100); }, 
        heal: () => { playTone(400, 'sine', 0.2); setTimeout(() => playTone(600, 'sine', 0.3), 200); },
        levelup: () => { playTone(300, 'square', 0.1); setTimeout(() => playTone(400, 'square', 0.1), 100); setTimeout(() => playTone(500, 'square', 0.3), 200); },
        camera: () => { playTone(800, 'square', 0.1); },
        type: () => { playTone(800, 'triangle', 0.05, 0.05); },
        start: () => { playTone(300, 'square', 0.1); setTimeout(() => playTone(600, 'square', 0.3), 100); },
        bossStart: () => { playTone(100, 'sawtooth', 0.5); setTimeout(() => playTone(80, 'sawtooth', 0.5), 400); },
        btn: () => { playTone(400, 'sine', 0.1, 0.05); }
    };

    window.updateUIFromCloud = () => {
        el.ballCount.textContent = window.playerData.pokeBalls;
        renderBag();
        updateStats(); // ç¢ºä¿å‰›ç™»å…¥æ™‚æ›´æ–°ç­‰ç´š/ç¶“é©—æ¢
        
        const mistakeSet = new Set(window.playerData.mistakes.map(m => m.charAt(0).toUpperCase()));
        document.querySelectorAll('.lvl-btn').forEach(btn => {
            if (mistakeSet.has(btn.textContent)) btn.classList.add('has-review');
            else btn.classList.remove('has-review');
        });
    };

    window.onload = async () => {
        const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        abc.forEach(char => {
            const b = document.createElement('div');
            b.className = 'lvl-btn'; b.textContent = char;
            b.onclick = () => { SFX.btn(); toggleLevel(char, b); };
            el.levelGrid.appendChild(b);
        });

        // å¼·åˆ¶ä½¿ç”¨ PokeAPI çš„åœ–ï¼Œé¿å… JSON ç¼ºåœ–
        try {
            el.msgBox.textContent = "æ­£åœ¨ä¸‹è¼‰åœ–é‘‘...";
            const res = await fetch(GITHUB_JSON_URL + '?t=' + Date.now());
            if(!res.ok) throw new Error("é€£ç·šå¤±æ•—");
            wordList = await res.json();
            el.msgBox.textContent = `âœ… å…± ${wordList.length} å€‹å–®å­—ã€‚è«‹é¸é—œå¡ã€‚`;
            el.msgBox.style.color = "green";
        } catch(e) {
            el.msgBox.textContent = "âŒ è¼‰å…¥å¤±æ•—"; el.msgBox.style.color = "red";
        }
    };

    el.btnShop.onclick = () => { SFX.btn(); el.shopModal.style.display = 'flex'; updateShopUI(); };
    el.btnCloseShop.onclick = () => { SFX.btn(); el.shopModal.style.display = 'none'; };
    el.btnBag.onclick = () => { SFX.btn(); currentBagPage = 1; bagSearchTerm = ''; el.bagSearch.value = ''; el.bagModal.style.display = 'flex'; renderBag(); };
    el.btnCloseBag.onclick = () => { SFX.btn(); el.bagModal.style.display = 'none'; };

    el.btnBuyPotion.onclick = () => {
        if (window.playerData.pokeBalls >= 3 && playerHp < playerMaxHp) {
            window.playerData.pokeBalls -= 3; playerHp++; SFX.heal(); updateStats(); updateShopUI();
            if(window.saveCloudData) window.saveCloudData('ball_use');
            el.msgBox.textContent = "ğŸ’– é«”åŠ›æ¢å¾©ï¼"; el.msgBox.style.color = "#e91e63";
        } else if (playerHp >= playerMaxHp) { alert("é«”åŠ›å·²ç¶“æ»¿äº†ï¼"); } 
        else { alert("ç²¾éˆçƒä¸å¤ å–”ï¼"); }
    };

    function updateShopUI() {
        el.btnBuyPotion.textContent = (playerHp >= playerMaxHp) ? "é«”åŠ›å·²æ»¿" : "è³¼è²· (3çƒ)";
        el.btnBuyPotion.disabled = (playerHp >= playerMaxHp || window.playerData.pokeBalls < 3);
    }

    // --- èƒŒåŒ…æ¸²æŸ“é‚è¼¯ ---
    function renderBag() {
        const groupedMap = new Map();
        window.playerData.pokemonBag.forEach(p => {
            if (!groupedMap.has(p.speciesId)) groupedMap.set(p.speciesId, { ...p, count: 0 });
            groupedMap.get(p.speciesId).count++;
        });
        
        let bag = Array.from(groupedMap.values());
        
        if (bagSearchTerm) {
            bag = bag.filter(p => (p.name && p.name.includes(bagSearchTerm)) || p.word.toLowerCase().includes(bagSearchTerm.toLowerCase()));
        }

        if (bagSortOrder === 'newest') bag.reverse(); 
        else bag.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

        el.totalCaught.textContent = window.playerData.pokemonBag.length; 
        el.pokedexGrid.innerHTML = '';
        
        if (bag.length === 0) {
            el.emptyBagMsg.style.display = 'block'; el.btnPhoto.style.display = 'none'; el.bagPagination.style.display = 'none';
            el.emptyBagMsg.textContent = bagSearchTerm ? "æ‰¾ä¸åˆ°ç¬¦åˆçš„å¯¶å¯å¤¢ã€‚" : "ç›®å‰é‚„æ˜¯ç©ºçš„ã€‚";
        } else {
            el.emptyBagMsg.style.display = 'none'; el.btnPhoto.style.display = 'block'; el.bagPagination.style.display = 'flex';
            const totalPages = Math.ceil(bag.length / ITEMS_PER_PAGE);
            if (currentBagPage > totalPages) currentBagPage = totalPages;
            if (currentBagPage < 1) currentBagPage = 1;

            el.pageInput.value = currentBagPage; el.pageInput.max = totalPages; el.totalPagesText.textContent = `/ ${totalPages}`;
            el.btnPrevPage.disabled = (currentBagPage === 1); el.btnNextPage.disabled = (currentBagPage === totalPages);

            const start = (currentBagPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = bag.slice(start, end);

            pageItems.forEach(p => {
                const card = document.createElement('div'); card.className = 'poke-card';
                const countBadge = p.count > 1 ? `<div class="count-badge">x${p.count}</div>` : '';
                const levelBadge = `<div class="level-badge">Lv.${p.level || 1}</div>`;
                card.innerHTML = `${countBadge}${levelBadge}<img src="${p.img}"><div class="poke-name">${p.name||'???'}</div><div class="poke-word">${p.word}</div>`;
                el.pokedexGrid.appendChild(card);
            });
        }
    }

    el.bagSearch.addEventListener('input', (e) => { bagSearchTerm = e.target.value; currentBagPage = 1; renderBag(); });
    el.btnSort.onclick = () => { bagSortOrder = (bagSortOrder === 'newest') ? 'az' : 'newest'; el.btnSort.textContent = (bagSortOrder === 'newest') ? "æ’åº: æœ€æ–°" : "æ’åº: åç¨±"; currentBagPage = 1; renderBag(); };
    el.btnPrevPage.onclick = () => { if(currentBagPage > 1) { currentBagPage--; renderBag(); SFX.btn(); }};
    el.btnNextPage.onclick = () => { let bag = [...window.playerData.pokemonBag]; const totalPages = Math.ceil(bag.length / ITEMS_PER_PAGE); if(currentBagPage < totalPages) { currentBagPage++; renderBag(); SFX.btn(); }};
    el.pageInput.onchange = () => { let p = parseInt(el.pageInput.value); if(p >= 1) { currentBagPage = p; renderBag(); }};

    el.btnPhoto.onclick = () => {
        SFX.camera(); el.btnPhoto.textContent = "ğŸ“· è™•ç†ä¸­...";
        el.btnPhoto.style.visibility = 'hidden'; el.btnCloseBag.style.visibility = 'hidden'; el.bagPagination.style.visibility = 'hidden';
        html2canvas(el.bagContentArea, { useCORS: true, scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            el.btnPhoto.style.visibility = 'visible'; el.btnCloseBag.style.visibility = 'visible'; el.bagPagination.style.visibility = 'visible';
            el.btnPhoto.textContent = "ğŸ“¸ åˆå½±ç•™å¿µ";
            const link = document.createElement('a'); link.download = 'my-pokedex.png';
            link.href = canvas.toDataURL(); link.click();
        });
    };

    function toggleLevel(char, btn) {
        if(isFighting || isRevealed) {
            if(!confirm("æˆ°é¬¥ä¸­åˆ‡æ›æœƒé‡ç½®é€²åº¦ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            resetGame();
        }
        if(selectedLetters.has(char)) { selectedLetters.delete(char); btn.classList.remove('active'); } 
        else { selectedLetters.add(char); btn.classList.add('active'); }
        if(selectedLetters.size > 0) {
            el.btnAction.textContent = "é–‹å§‹"; el.btnAction.disabled = false; el.btnAction.style.background = "#28a745";
            el.msgBox.textContent = `å·²é¸ ${Array.from(selectedLetters).join(',')}ï¼ŒæŒ‰é–‹å§‹ï¼`;
        } else {
            el.btnAction.textContent = "è«‹é¸é—œå¡"; el.btnAction.disabled = true; el.btnAction.style.background = "#ccc";
        }
    }

    el.btnAction.onclick = () => {
        SFX.btn();
        if(!isFighting && !isRevealed) initBattle();
        else if(isFighting) playerAttack();
        else if(isRevealed) {
            if (isBossRound && enemyCurrentHp > 0) loadNextQuestion();
            else nextEnemy();
        }
    };

    el.btnRun.onclick = () => {
        if(!isFighting) return;
        SFX.error(); el.msgBox.textContent = "ğŸ’¨ é€ƒè·‘æˆåŠŸ (è·³é)"; el.msgBox.style.color = "orange";
        showDamage(0, true); 
        if(window.saveCloudData) window.saveCloudData('add_mistake', { word: currentEnemy.word });
        if(!window.playerData.mistakes.includes(currentEnemy.word)) window.playerData.mistakes.push(currentEnemy.word);
        revealAnswer(false);
    };

    el.input.addEventListener('keyup', (e) => {
        if(e.key === 'Enter' && !el.btnAction.disabled) el.btnAction.click();
    });
    el.input.addEventListener('input', () => { SFX.type(); });

    function initBattle() {
        const pool = wordList.filter(w => selectedLetters.has(w.word.charAt(0).toUpperCase()));
        if(pool.length === 0) { el.msgBox.textContent = "æ­¤é—œå¡æ²’æœ‰æ€ªç¸ï¼"; return; }
        
        const mistakeSet = new Set(window.playerData.mistakes);
        const reviewWords = pool.filter(w => mistakeSet.has(w.word)); 
        const newWords = pool.filter(w => !mistakeSet.has(w.word));   
        battleQueue = [...shuffle(reviewWords), ...shuffle(newWords)];
        
        SFX.start(); playerHp = playerMaxHp; stageCount = 0; updateStats();
        el.btnAction.style.background = "#ff3333"; nextEnemy();
    }

    async function nextEnemy() {
        if(playerHp <= 0) { gameOver(false); return; }
        if(battleQueue.length === 0) { gameOver(true); return; }

        stageCount++; 
        isBossRound = (stageCount % 5 === 0);
        
        currentEnemyId = getRandomPokemonId(isBossRound);
        // å¼·åˆ¶ä½¿ç”¨ PokeAPI åœ–ï¼Œå¿½ç•¥ JSON åœ– (ä¿®å¾©åœ–ç‰‡é¡¯ç¤ºå•é¡Œ)
        currentEnemyImgUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${currentEnemyId}.png`;
        
        el.enemyName.textContent = "???";
        currentEnemyName = await fetchPokemonName(currentEnemyId);
        el.enemyName.textContent = isBossRound ? `(é­”ç‹) ${currentEnemyName}` : `é‡ç”Ÿ ${currentEnemyName}`;

        if (isBossRound) {
            enemyMaxHp = Math.floor(Math.random() * 3) + 8; enemyCurrentHp = enemyMaxHp;
            el.scene.classList.add('boss-bg'); el.enemyImg.classList.add('boss-size');
            el.gameFrame.classList.add('boss-mode'); el.enemyHpBar.classList.add('hp-purple');
            SFX.bossStart(); el.msgBox.textContent = "âš ï¸ è­¦å‘Šï¼é­”ç‹å‡ºç¾ï¼"; el.msgBox.style.color = "#9c27b0";
        } else {
            enemyMaxHp = 1; enemyCurrentHp = 1;
            el.scene.classList.remove('boss-bg'); el.enemyImg.classList.remove('boss-size');
            el.gameFrame.classList.remove('boss-mode'); el.enemyHpBar.classList.remove('hp-purple');
            el.msgBox.textContent = `é­é‡ ${currentEnemyName}ï¼`; el.msgBox.style.color = "#333";
        }

        updateStats(); el.enemyImg.style.backgroundImage = `url('${currentEnemyImgUrl}')`;
        el.enemyImg.style.filter = "none"; el.playerImg.classList.remove('shake');
        loadNextQuestion();
    }

    function loadNextQuestion() {
        if (battleQueue.length === 0) { gameOver(true); return; }
        currentEnemy = battleQueue.shift();
        isFighting = true; isRevealed = false;

        el.input.value = ""; el.input.disabled = false; el.input.focus();
        const len = currentEnemy.word.length; el.input.placeholder = `${"_ ".repeat(len)} (${len})`;

        el.btnAction.textContent = "æ”»æ“Š (Enter)"; el.btnAction.disabled = false; el.btnAction.style.background = "#ff3333";
        el.btnRun.disabled = false; el.btnVoiceWord.disabled = false; el.btnVoiceSent.disabled = false;
        
        el.questionBox.innerHTML = `<div id="qText" class="q-word"></div><div id="qHint" class="q-hint"></div>`;
        el.qText = document.getElementById('qText'); el.qHint = document.getElementById('qHint');

        const type = currentEnemy.type ? `(${currentEnemy.type})` : "";
        el.qText.textContent = `${currentEnemy.cn_word} ${type}`;
        
        let maskedSent = "";
        if(currentEnemy.sentence) {
            const reg = new RegExp(currentEnemy.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            maskedSent = currentEnemy.sentence.replace(reg, '____');
        }
        el.qHint.textContent = maskedSent;
    }

    function playerAttack() {
        const ans = el.input.value.trim().toLowerCase();
        const correct = currentEnemy.word.trim().toLowerCase();

        if(ans === correct) {
            SFX.attack(); el.playerImg.classList.add('attack-anim');
            setTimeout(() => el.playerImg.classList.remove('attack-anim'), 300);
            
            setTimeout(() => {
                SFX.hit(); enemyCurrentHp--; showDamage(1, false); updateStats();
                el.enemyImg.style.filter = "brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5)";
                setTimeout(() => { if (enemyCurrentHp > 0) el.enemyImg.style.filter = "none"; }, 300);

                if (enemyCurrentHp <= 0) {
                    enemyCurrentHp = 0; 
                    window.playerData.pokeBalls++; // é‡‘å¹£
                    
                    // å‡ç´šè¨ˆç®—
                    const expGain = 20; window.playerData.exp += expGain;
                    if (window.playerData.exp >= getMaxExp(window.playerData.level)) {
                        window.playerData.exp -= getMaxExp(window.playerData.level);
                        window.playerData.level++; playerHp = playerMaxHp; SFX.levelup();
                        el.msgBox.textContent = `ğŸ†™ å‡ç´šï¼Lv.${window.playerData.level}ï¼`;
                        el.playerImg.classList.add('levelup-anim');
                        setTimeout(() => el.playerImg.classList.remove('levelup-anim'), 1000);
                    } else {
                        SFX.coin(); el.msgBox.textContent = `ğŸ’¥ æ”¶æœï¼+1çƒ +${expGain}XP`;
                    }
                    el.msgBox.style.color = "green"; el.enemyImg.style.filter = "brightness(0) opacity(0.5)";

                    const newPokemon = {
                        instanceId: Date.now().toString(36),
                        speciesId: currentEnemyId,
                        img: currentEnemyImgUrl,
                        name: currentEnemyName,
                        level: 1, // é è¨­æŠ“åˆ°çš„æ€ªæ˜¯ 1 ç­‰
                        word: currentEnemy.word,
                        caughtDate: new Date().toISOString()
                    };
                    window.playerData.pokemonBag.push(newPokemon);
                    
                    const mIdx = window.playerData.mistakes.indexOf(currentEnemy.word);
                    if(mIdx > -1) window.playerData.mistakes.splice(mIdx, 1);

                    if(window.saveCloudData) window.saveCloudData('catch_pokemon', { pokemon: newPokemon, word: currentEnemy.word });

                } else {
                    el.msgBox.textContent = `âš”ï¸ å‘½ä¸­ï¼é­”ç‹å‰© ${enemyCurrentHp} è¡€ï¼`; el.msgBox.style.color = "blue";
                }
                updateStats(); revealAnswer(true);
            }, 200);
            speak(currentEnemy.word);
        } else {
            SFX.error(); playerHp--; updateStats();
            el.playerImg.classList.add('shake'); setTimeout(() => el.playerImg.classList.remove('shake'), 500);
            showDamage(1, true);
            if(!window.playerData.mistakes.includes(currentEnemy.word)) window.playerData.mistakes.push(currentEnemy.word);
            if(window.saveCloudData) window.saveCloudData('add_mistake', { word: currentEnemy.word });

            if(playerHp <= 0) { setTimeout(() => gameOver(false), 1000); } 
            else { el.msgBox.textContent = "âŒ æ”»æ“Šå¤±èª¤ï¼å—åˆ°åæ“Šï¼"; el.msgBox.style.color = "red"; el.input.value = ""; el.input.focus(); }
        }
    }

    function revealAnswer(isWin) {
        isFighting = false; isRevealed = true;
        el.input.disabled = true; el.btnRun.disabled = true;
        if (enemyCurrentHp > 0) el.btnAction.textContent = "ä¸‹ä¸€é¡Œ (æˆ°é¬¥)";
        else el.btnAction.textContent = "ä¸‹ä¸€éš»";
        el.btnAction.style.background = "#2196f3";
        el.qText.innerHTML = `<span style="color:red; font-size:1.2em;">${currentEnemy.word}</span> <span style="font-size:0.6em; color:#666;">${currentEnemy.KK||''}</span>`;
        if(currentEnemy.sentence) el.qHint.textContent = currentEnemy.sentence;
    }

    function showDamage(amount, isPlayerHurt) {
        const dmg = document.createElement('div'); dmg.className = 'damage-text';
        dmg.textContent = `-${amount}`; dmg.style.color = isPlayerHurt ? 'red' : 'orange';
        if(isPlayerHurt) { dmg.style.left = "40px"; dmg.style.top = "60px"; } 
        else { dmg.style.right = "40px"; dmg.style.bottom = "80px"; }
        el.scene.appendChild(dmg); setTimeout(() => dmg.remove(), 800);
    }

    function updateStats() {
        const ePct = (enemyCurrentHp / enemyMaxHp) * 100;
        el.enemyHpBar.style.width = ePct + "%"; el.enemyHpText.textContent = `${enemyCurrentHp}/${enemyMaxHp}`;
        
        const pPct = (playerHp / playerMaxHp) * 100;
        el.playerHpBar.style.width = pPct + "%"; el.playerHpText.textContent = `${playerHp}/${playerMaxHp}`;
        el.playerHpBar.className = "hp-bar-fill " + (pPct > 50 ? "hp-green" : pPct > 20 ? "hp-yellow" : "hp-red");
        
        const maxExp = getMaxExp(window.playerData.level);
        const expPct = (window.playerData.exp / maxExp) * 100;
        el.playerExpBar.style.width = expPct + "%";
        el.playerLevelText.textContent = `Lv.${window.playerData.level}`;

        el.ballCount.textContent = window.playerData.pokeBalls;
    }

    function gameOver(isClear) {
        isFighting = false; isRevealed = false;
        el.btnAction.textContent = "é‡æ–°æŒ‘æˆ°"; el.btnAction.style.background = "#28a745";
        el.btnAction.disabled = false; el.input.disabled = true;
        if(isClear) {
            SFX.win();
            el.questionBox.innerHTML = `<div style="font-size: 2em;">ğŸ†</div><div class="game-over-title">æ­å–œé€šé—œï¼</div><div class="game-over-desc">ä½ æ˜¯å¯¶å¯å¤¢å¤§å¸«ï¼</div>`;
            el.msgBox.textContent = "å¤ªå¼·äº†ï¼";
        } else {
            SFX.error();
            el.questionBox.innerHTML = `<div style="font-size: 3em; margin-bottom:5px;">ğŸ’€</div><div style="color: #2a75bb; font-size: 1.8em; font-weight: bold; margin-bottom: 5px;">çœ¼å‰ä¸€ç‰‡æ¼†é»‘...</div><div style="color: #666; font-size: 1em;">è¨“ç·´å®¶å€’ä¸‹äº†ï¼Œè«‹é‡æ–°æŒ‘æˆ°ï¼</div>`;
            el.msgBox.textContent = "æˆ°æ•—...";
        }
    }

    function resetGame() {
        isFighting = false; isRevealed = false;
        selectedLetters.clear();
        document.querySelectorAll('.lvl-btn.active').forEach(b => b.classList.remove('active'));
        el.btnAction.textContent = "è«‹é¸é—œå¡"; el.btnAction.disabled = true; el.btnAction.style.background = "#ccc";
        el.questionBox.innerHTML = `<div id="qText" class="q-word">è«‹å…ˆé¸æ“‡ä¸Šæ–¹é—œå¡</div><div id="qHint" class="q-hint"></div>`;
        el.qText = document.getElementById('qText'); el.qHint = document.getElementById('qHint');
        enemyHp = 100; playerHp = 3; updateStats();
        window.updateUIFromCloud();
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = parseFloat(el.rateSlider.value);
            window.speechSynthesis.speak(u);
        }
    }
    
    el.btnVoiceWord.onclick = () => { if(currentEnemy) speak(currentEnemy.word); };
    el.btnVoiceSent.onclick = () => { if(currentEnemy && currentEnemy.sentence) speak(currentEnemy.sentence); };

</script>
</body>
</html>
